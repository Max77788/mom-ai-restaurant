{% extends 'layout_no_land.html' %}

{% block content %}
<body>
    <h1 class="mb-4" style="text-align: center; position: relative;">
        {% if initial_setup %}Setup the menu{% else %}Update the menu{% endif %}
        <!-- Add your element here -->
        {% if initial_setup %}
        <a href="/set-working-hours?start_setup=True" style="position: absolute; top: 0; right: 0; font-size: 18px; color: #000;">
            <u>Skip for Now -></u>
        </a>
        {% else %}
        <a href="/dashboard" style="position: absolute; top: 0; right: 0; font-size: 18px; color: #000;">
            <u>Go to Dashboard -></u>
        </a>
        {% endif %}
    </h1>

    <h3 style="text-align: center; margin-bottom: 7px;"><a href="https://chatgpt.com/g/g-CJCHfiKMQ-mom-ai-restaurant-assistant" target="_blank" style="margin-top:20px; margin-bottom: 20px;"><u>Talk to MOM AI GPT and Get Extra Assistance!</u></a>
        <br>&amp;<br>
        Watch This Comprehensive Tutorial on How to Form Menu!</h3>
        <div style="margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%;">
    <iframe width="560" height="315" 
        src="https://www.youtube.com/embed/dy4DO92oTcU" 
        title="YouTube video player" 
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
        allowfullscreen>
    </iframe>
   
    </div>

    <hr>

    <h1 style="text-align: center;">Set the currency</h1>

    <!-- Form to select currency -->
{% if initial_setup %}
<form id="currencyForm" action="/set-currency?initial_setup=True" method="POST">
{% else %}
<form id="currencyForm" action="/set-currency" method="POST">
{% endif %}
    <!-- Dropdown for top 10 currencies -->
    <label for="currency">Select Currency:</label>
    <select id="currency" name="currency" style="max-width: 300px;">
        <option value="{{ currency }}" selected>{{ currency }}</option>
        <option value="USD">USD - US Dollar</option>
        <option value="EUR">EUR - Euro</option>
        <option value="JPY">JPY - Japanese Yen</option>
        <option value="GBP">GBP - British Pound</option>
        <option value="THB">THB - Thai Bant</option>
        <option value="AUD">AUD - Australian Dollar</option>
        <option value="CAD">CAD - Canadian Dollar</option>
        <option value="CHF">CHF - Swiss Franc</option>
        <option value="CNY">CNY - Chinese Yuan</option>
        <option value="SEK">SEK - Swedish Krona</option>
        <option value="NZD">NZD - New Zealand Dollar</option>
        <option value="ISK">ISK - Icelandic Krona</option>
    </select>

    <!-- Button to submit the form -->
    <button type="submit" style="margin-top: 10px;">Set Currency</button>
    
</form>

<hr>


    <h1 style="text-align: center;">Upload the menu file & image</h1>
    {% if initial_setup %}
    <form action="/update_menu?initial_setup=True" method="post" enctype="multipart/form-data" onsubmit="showLoadingGif()">
        <div>
            <label for="menu_update">‚¨áÔ∏èUpload the menu(rewrites the whole menuüìñ)</label>
            {{ form.menu_update }}
        </div>
        <div style="margin-top: 7px;">
            {{ form.submit }}
        </div>
    </form>
    {% else %}
    <form action="/update_menu" method="post" enctype="multipart/form-data" onsubmit="showLoadingGif()">
        <div>
            <label for="menu_update">‚¨áÔ∏èUpload the menu(rewrites the whole menuüìñ)</label>
            {{ form.menu_update }}
        </div>
        <div style="margin-top: 7px;">
            {{ form.submit }}
        </div>
    </form>
    {% endif %}
    <form action="/upload_full_menu_picture" method="post" enctype="multipart/form-data" onsubmit="return checkFiles(); showLoadingGif()">
        <div style="margin-top: 7px;">
            <label id="menu_images_label" for="menu_images">‚¨áÔ∏èUpload menu images (max 4 files)</label>
            <input type="file" id="menu_images" name="menu_images" accept="image/*" multiple>
        </div>
    
        <!-- New div to display previously uploaded images with X icon for deletion -->
        <div style="margin-top: 7px; display: flex; flex-wrap: wrap; gap: 10px;">
            {% for image_url in menu_images %}
                <div style="display: inline-block; position: relative;">
                    <!-- X icon for deletion -->
                    <span class="delete-btn" style="position: absolute; top: 5px; right: 5px; background-color: red; color: white; cursor: pointer; padding: 2px 5px; border-radius: 50%;" onclick="deleteImage('{{ image_url }}')">X</span>
                    <img src="{{ image_url }}" alt="Menu Image" style="width: 100px; height: 100px; object-fit: cover;">
                </div>
            {% endfor %}
        </div>
    
        <div style="margin-top: 7px;">
            <button type="submit" class="btn btn-primary">Upload Images</button>
        </div>
    </form>







    <!-- Modal for displaying extracted menu -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
        <span class="close">&times;</span>
        <h2 style="text-align: center;">Extracted Menu Items</h2>


        <!-- Add new row form -->
        <div>
            <input type="text" id="newItemName" placeholder="Item Name">
            <input type="text" id="newItemDescription" placeholder="Item Description">
            <input type="number" id="newItemPrice" placeholder="Item Price">
            <button id="addRowBtn" style="margin-top: 5px; margin-bottom: 5px;">Add Row</button>
        </div>


        <table id="extractedMenuTable" border="1" class="dataframe table table-striped">
            <thead>
            <tr>
                <th>Item Name</th>
                <th>Item Description</th>
                <th>Item Price</th>
            </tr>
            </thead>
            <tbody id="extractedMenuBody">
            <!-- Dynamically populated rows go here -->
            </tbody>
        </table>
    
        <!-- Buttons for appending or replacing menu items -->
        <button id="appendMenuBtn">Append to Existing Menu</button>
        <button id="replaceMenuBtn">Replace Existing Menu</button>
        </div>
    </div>
  
  <!-- Modal CSS -->
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
  
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
  
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
  
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
  




    <form action="/trigger_extract_menu_from_image" method="post" enctype="multipart/form-data" id="generate_menu_from_images_form" style="text-align: center;">
        <div style="margin-top: 7px;">
            <label id="menu_images_extract_menu_label" for="menu_images_extract_menu">Have MOM AI Make Your Menu Just from Images</label>
            <input type="file" id="menu_images_extract_menu" name="menu_images_extract_menu" accept="image/*" multiple>
        </div>
    
        <div style="margin-top: 7px;">
            <button type="submit" class="btn btn-primary">Upload Images</button>
        </div>
    </form>
    
    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <img src="/static/assets/loading-gif.gif" width="70" style="display: none;" id="loadingGifExtractMenuItems">
    </div>




    
    <script>
        // Pass the number of already uploaded images from the server to JavaScript
        var existingImageCount = {{ menu_images | length }};
        var maxFiles = 4;
        var remainingFiles = maxFiles - existingImageCount;
    
        // Dynamically update the label text
        var label = document.getElementById('menu_images_label');
        label.textContent = `‚¨áÔ∏èUpload menu images (you can upload ${remainingFiles} more file${remainingFiles !== 1 ? 's' : ''})`;
    
        // Delete image function, calls the delete route via AJAX
        function deleteImage(imageUrl) {
            if (confirm("Are you sure you want to delete this image?")) {
                // Send a delete request using AJAX (Fetch API)
                fetch('/delete_menu_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image_url: imageUrl })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Image deleted successfully');
                        location.reload();  // Reload the page to reflect changes
                    } else {
                        alert('Failed to delete image');
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
            }
        }
    
        function checkFiles() {
            var input = document.getElementById('menu_images');
            var maxFilesAllowed = maxFiles - existingImageCount; // Dynamically calculate remaining file slots
    
            if (input.files.length > maxFilesAllowed) {
                alert('You can only upload a maximum of ' + maxFilesAllowed + ' more file(s).');
                return false;
            }
            return true;
        };

        document.getElementById("generate_menu_from_images_form").addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent the default form submission
            
            const formData = new FormData();
            const fileInput = document.getElementById('menu_images_extract_menu');
            const files = fileInput.files;

            // Append the files to the FormData object
            for (let i = 0; i < files.length; i++) {
                formData.append('menu_images_extract_menu', files[i]);
            }

            // Display the loading GIF or message
            document.getElementById("loadingGifExtractMenuItems").style.display = 'block';

            // Fetch request to trigger menu extraction
            fetch('/trigger_extract_menu_from_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.task_id) {
                    console.log("Task ID: ", data.task_id);
                    // Polling function to check task status
                    pollTaskStatus(data.task_id);
                } else {
                    console.error("Failed to trigger task");
                }
            })
            .catch(error => {
                console.error("Error occurred: ", error);
            });
        });

        function pollTaskStatus(taskId) {
            const interval = setInterval(() => {
                fetch(`/extract_menu_from_image_status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Task Status: ", data.state);
                    
                    if (data.state === 'SUCCESS') {
                        
                        clearInterval(interval); // Stop polling
                        console.log("Menu List: ", data.menu_list);
                        // alert('Task completed! Check the console for menu data.');
                        document.getElementById('loadingGifExtractMenuItems').style.display = 'none';
                        showMenuModal(data.menu_list);

                    } else if (data.state === 'FAILURE') {
                        clearInterval(interval); // Stop polling
                        alert('Task failed: ' + data.status);
                        document.getElementById('loadingGifExtractMenuItems').style.display = 'none';
                    } else {
                        console.log("Status: ", data.status); // Keep polling while pending or retrying
                    }
                })
                .catch(error => {
                    clearInterval(interval);
                    console.error("Error checking task status: ", error);
                });
            }, 3000); // Poll every 3 seconds
        };

        // Function to show the modal with the extracted menu items
function showMenuModal(extractedMenu) {
    const modal = document.getElementById("menuModal");
    const closeBtn = document.getElementsByClassName("close")[0];
    const extractedMenuBody = document.getElementById("extractedMenuBody");

    // Clear any previous entries in the table
    extractedMenuBody.innerHTML = "";

    // Populate table with extracted items
    extractedMenu.forEach(item => {
        const row = document.createElement("tr");

        const nameCell = document.createElement("td");
        nameCell.contentEditable = "true";  // Make the cells editable
        nameCell.innerText = item.item_name;
        row.appendChild(nameCell);

        const descCell = document.createElement("td");
        descCell.contentEditable = "true";
        descCell.innerText = item.item_description;
        row.appendChild(descCell);

        const priceCell = document.createElement("td");
        priceCell.contentEditable = "true";
        priceCell.innerText = item.item_price;
        row.appendChild(priceCell);

        // Add delete button for each row
        const actionCell = document.createElement("td");
        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "Delete";
        deleteBtn.onclick = function () {
            row.remove();  // Remove the row when clicked
        };
        actionCell.appendChild(deleteBtn);
        row.appendChild(actionCell);

        extractedMenuBody.appendChild(row);
    });

    // Show the modal
    modal.style.display = "block";

    // Close the modal when the 'x' is clicked
    closeBtn.onclick = function () {
        modal.style.display = "none";
    };
}

// Function to compile the table data into an array of objects
function compileTableData() {
    const tableRows = document.querySelectorAll("#extractedMenuTable tbody tr");
    const menuItems = [];

    tableRows.forEach(row => {
        const itemName = row.cells[0].innerText.trim();
        const itemDescription = row.cells[1].innerText.trim();
        const itemPrice = row.cells[2].innerText.trim();

        // Push each menu item as an object
        menuItems.push({
            'Item Name': itemName,
            'Item Description': itemDescription,
            'Item Price (EUR)': parseFloat(itemPrice)  // Ensure price is a float
        });
    });

    return menuItems;  // Return the compiled menu items
}

// Add event listener to the "Add Row" button
document.getElementById("addRowBtn").addEventListener("click", function () {
    const newItemName = document.getElementById("newItemName").value.trim();
    const newItemDescription = document.getElementById("newItemDescription").value.trim();
    const newItemPrice = document.getElementById("newItemPrice").value.trim();

    // Validate that the inputs are not empty
    if (!newItemName || !newItemDescription || !newItemPrice || isNaN(newItemPrice)) {
        alert("Please fill out all fields correctly.");
        return;
    }

    // Create a new row
    const row = document.createElement("tr");

    const nameCell = document.createElement("td");
    nameCell.contentEditable = "true";  // Make the cells editable
    nameCell.innerText = newItemName;
    row.appendChild(nameCell);

    const descCell = document.createElement("td");
    descCell.contentEditable = "true";
    descCell.innerText = newItemDescription;
    row.appendChild(descCell);

    const priceCell = document.createElement("td");
    priceCell.contentEditable = "true";
    priceCell.innerText = parseFloat(newItemPrice).toFixed(2);  // Format price
    row.appendChild(priceCell);

    // Add delete button for the new row
    const actionCell = document.createElement("td");
    const deleteBtn = document.createElement("button");
    deleteBtn.innerText = "Delete";
    deleteBtn.onclick = function () {
        row.remove();  // Remove the row when clicked
    };
    actionCell.appendChild(deleteBtn);
    row.appendChild(actionCell);

    // Add the new row to the table
    document.getElementById("extractedMenuBody").appendChild(row);

    // Clear the input fields
    document.getElementById("newItemName").value = '';
    document.getElementById("newItemDescription").value = '';
    document.getElementById("newItemPrice").value = '';
});



        // Append button click handler
        document.getElementById('appendMenuBtn').addEventListener('click', function() {
        const menuItems = compileTableData();

        fetch('/handle_ai_generated_menu?append=True', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ menu_items: menuItems })  // Send the compiled list
        })
        .then(response => response.json())  // Parse the JSON response
        .then(data => {
            if (data.success) {
            alert('Menu items appended successfully!');
            // Optionally close the modal or refresh the page
            location.reload()
            } else {
            alert('Failed to append menu items.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while appending menu items.');
        });
        });

        // Replace button click handler
        document.getElementById('replaceMenuBtn').addEventListener('click', function() {
        const menuItems = compileTableData();

        fetch('/handle_ai_generated_menu?replace=True', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ menu_items: menuItems })  // Send the compiled list
        })
        .then(response => response.json())  // Parse the JSON response
        .then(data => {
            if (data.success) {
            alert('Menu replaced successfully!');
            // Optionally close the modal or refresh the page
            location.reload()
            } else {
            alert('Failed to replace menu items.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while replacing menu items.');
        });
        });


    </script>

    {% if initial_setup or default_menu %}
    <div style="display:flex; flex-direction: column; align-items: center;">
        <h2 style="text-align: center;">or</h2>
        <div style="display:flex; flex-direction: column; align-items: center; border: 2px solid #000; border-radius: 10px; padding: 10px;">
        <h1 style="text-align: center;">Add Menu Items One-by-One</h1>
        <form id="menuForm" action="/submit_menu" method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
            {{ form.hidden_tag() }}
            <input type="text" name="item_name" placeholder="Item Name" required style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
            <input type="text" name="item_description" placeholder="Item Description" required style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
            <input type="number" step="0.01" name="item_price" placeholder="Item Price ({{ currency }})" required style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
            <input type="url" name="item_image_link" placeholder="Link to Image" style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
            <button type="button" id="addItemBtn">Add Item</button>
        </form>
        </div>

        <table id="itemTable" border="1" class="dataframe table table-striped" style="margin-top: 20px;">
            <thead>
                <tr style="text-align: right;">
                    <th>Item Name</th>
                    <th>Item Description</th>
                    <th>Item Price ({{ currency }})</th>
                    <th>Link to Image</th>
                    <th>Image</th>
                </tr>
            </thead>
            <tbody>
                <!-- Items will be dynamically added here -->
            </tbody>
        </table>

        <button type="submit" id="submitMenuBtn" style="margin-top: 20px;">Submit Menu</button>
    </div>

    <script>
        
        


        function showLoadingGif() {
            document.getElementById('loadingGif').style.display = 'block';
        }

        function hideLoadingGif() {
            document.getElementById('loadingGif').style.display = 'none';
        }
        
        document.getElementById('addItemBtn').addEventListener('click', function() {
            
            // Get the values from the form inputs
            let itemName = document.getElementsByName('item_name')[0].value.trim();
            let itemDescription = document.getElementsByName('item_description')[0].value.trim();
            let itemPrice = document.getElementsByName('item_price')[0].value.trim();
            let itemImageLink = document.getElementsByName('item_image_link')[0].value.trim();

            // Validation
            if (!itemName || !itemDescription) {
                alert('Item Name and Item Description are required.');
                return;
            }

            if (isNaN(itemPrice) || itemPrice <= 0) {
                alert('Item Price must be a valid number greater than 0.');
                return;
            }

            console.log(`Item Image Link ${itemImageLink}`)

            if (!isValidUrl(itemImageLink)) {
                alert('The Image Link must be a valid URL.');
                return;
            }

            // Create a new row in the table
            let table = document.getElementById('itemTable').getElementsByTagName('tbody')[0];
            let newRow = table.insertRow(0);

            newRow.innerHTML = `
                <td contenteditable="true" data-column="Item Name" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">${itemName}</td>
                <td contenteditable="true" data-column="Item Description" style="max-width: 300px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">${itemDescription}</td>
                <td contenteditable="true" data-column="Item Price (EUR)" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${parseFloat(itemPrice).toFixed(2)}</td>
                <td contenteditable="true" data-column="Link to Image" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">${itemImageLink}</td>
                <td contenteditable="false" data-column="Image" style="max-width: 170px;"><img src="${itemImageLink}" alt="Here could be an image of ${itemName}. Have AI-image generated for 0.05 EUR in less than a minute‚û°Ô∏è" width="170" height="auto"></td>
                <td><button class="delete-add-oneByOne-row-btn">Delete</button></td>    
            `;


            // Clear the form inputs
            document.getElementById('menuForm').reset();

            attachDeleteOneByOneListeners();
        });

        // Add event listener to all delete buttons
        document.addEventListener('DOMContentLoaded', function() {
            
            
            document.querySelectorAll('.delete-add-row-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    // Find the row that the button is in and remove it
                    let row = button.closest('tr');
                    row.parentNode.removeChild(row);
                });
            });

        });

        document.addEventListener('DOMContentLoaded', function() {
            var select = document.getElementById('currency');
            var form = document.getElementById('currencyForm');
            var initialValue = select.value;

            select.addEventListener('change', function() {
                if (this.value !== initialValue) {
                    form.submit();
                }
            });
        });

        // Add event listener to all delete buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.delete-add-oneByOne-row-btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    // Find the row that the button is in and remove it
                    let row = button.closest('tr');
                    row.parentNode.removeChild(row);
                });
            });
        });

        


        document.getElementById('submitMenuBtn').addEventListener('click', function() {
            document.getElementById("loadingGif").style.display = "block";
            
            let rows = document.querySelectorAll('#itemTable tbody tr');
            let items = [];

            rows.forEach(function(row) {
                let item = {
                    "Item Name": row.cells[0].innerText,
                    "Item Description": row.cells[1].innerText,
                    "Item Price (EUR)": row.cells[2].innerText,
                    "Link to Image": row.cells[3].innerText
                };
                items.push(item);
            });

            const data_to_send = {
                "unique_azz_id": "{{ unique_azz_id }}",
                "updatedItems": items
            };

            fetch('/update_menu_manual', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data_to_send)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Menu updated successfully!');
                    const initial_setup = "{{ initial_setup }}" === "True"
                    
                    if(!initial_setup){
                    location.reload();
                    } else {
                        window.location.href = "/dashboard?show_popup=True"
                    }
                } else {
                    alert('Failed to update the menu.');
                }
            });
        });
    </script>
    {% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            
            
            
           /* 
            // Warn the user when trying to close the tab with unsaved changes
        window.addEventListener('beforeunload', function(event) {
            event.preventDefault();
            event.returnValue = '';
        });
         */
        });
        

    </script>

    <hr>
    <div class="container mt-5">
        <!-- New Item Form -->
        {% if not default_menu and not initial_setup %}
        <div style="display:flex; flex-direction: column; align-items: center; border: 2px solid #000; border-radius: 10px; padding: 10px;">
            <h3 style="text-align: center;">Add a New Menu Item Manually</h3>
            <div id="newItemForm" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
              <input type="text" id="newItemName" placeholder="Item Name" required style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
              
              <div style="display: flex; align-items: center; width: 100%; justify-content: space-between; margin-bottom: 10px;">
                <input type="text" id="newItemDescription" placeholder="Item Description" required style="width: 300px; padding: 10px; border-radius: 5px;">
                <button id="generateAI" disabled style="margin-left: 10px;">Generate with AI</button>
              </div>
          
              <input type="number" step="0.01" id="newItemPrice" placeholder="Item Price ({{ currency }})" required style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
              <input type="url" id="newItemImageLink" placeholder="Link to Image" style="width: 300px; margin-bottom: 10px; padding: 10px; border-radius: 5px;">
              <button id="addNewItemBtn">Add Item</button>
            </div>
          </div>
          
          <script>
            const newItemNameInput = document.getElementById('newItemName');
            const newItemDescriptionInput = document.getElementById('newItemDescription');
            const generateAIButton = document.getElementById('generateAI');
            
            // Enable the "Generate with AI" button when the "Item Name" field has a value
            newItemNameInput.addEventListener('input', () => {
              generateAIButton.disabled = !newItemNameInput.value.trim();
            });
          
            // Handle the click event of the "Generate with AI" button
            generateAIButton.addEventListener('click', async () => {
              if (newItemNameInput.value.trim()) {
                // Block the inputs
                newItemNameInput.disabled = true;
                newItemDescriptionInput.disabled = true;
                generateAIButton.disabled = true;
          
                try {
                  const response = await fetch('/generate_item_description', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_name: newItemNameInput.value.trim() })
                  });
          
                  const data = await response.json();
                  
                  // Set the generated description
                  newItemDescriptionInput.value = data.item_description;
          
                } catch (error) {
                  console.error('Error generating description:', error);
                } finally {
                  // Unblock the inputs
                  newItemNameInput.disabled = false;
                  newItemDescriptionInput.disabled = false;
                  generateAIButton.disabled = false;
                }
              }
            });
          </script>
        </div>

        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <img src="/static/assets/loading-gif.gif" width="70" style="display: none;" id="loadingGif">
        </div>

        {% endif %}

        <div style="display: flex; align-items: center; justify-content: center;">
            <button id="saveChangesBtn" style="margin-top: 20px; flex-direction: column; align-items: center; padding: 15px 30px; font-size: 18px; border-radius: 10px; width: 200px; height: 60px;">Save Changes</button>
        </div>
        <p style="font-size: 10px; text-align: center; margin-bottom: 10px;">Press this button when you have added new positions and removed irrelevant items</p>

        {% if default_menu %}
        <h1 class="mb-4" style="text-align: center;">That's the example of the menu you should provide</h1>
        {% else %}
        <h1 class="mb-4" style="text-align: center;">That's the menu the assistant refers to now</h1>
        <h2 class="mb-4" style="text-align: center;">‚¨áÔ∏èEdit the menu right in the table‚¨áÔ∏è</h2>
    

        {% endif %}    
        <!-- Export as CSV Button -->
        <div style="text-align: center; margin-top: 20px;">
            <button id="exportCsvBtn">Export as CSV</button>
        </div>

        
        <div class="mt-4">
            <div class="menu-content table-responsive">
                <table id="menuTable" border="1" class="dataframe table table-striped">
                    <thead>
                        <tr style="text-align: right;">
                            <th>Item Name</th>
                            <th>Item Description</th>
                            <th>Item Price ({{ currency }})</th>
                            <th>Link to Image</th>
                            <th>Image</th>
                            <th>AI-Image</th> <!-- New Column -->
                            <th>Remove Item</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        {% if not default_menu %}
                        {% for item in html_menu_tuples %}
                        <tr>
                          <td contenteditable="true" data-column="Item Name" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Item Name"] }}</td>
                          <td contenteditable="true" data-column="Item Description" style="max-width: 300px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Item Description"] }}</td>
                          <td contenteditable="true" data-column="Item Price (EUR)" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ item["Item Price (EUR)"] }}</td>
                          <td contenteditable="true" data-column="Link to Image" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Link to Image"] }}</td>
                          <td contenteditable="false" data-column="Image" style="max-width: 180px;"><img src="{{ item['Link to Image'] }}" alt="Here could be an image of {{ item['Item Name'] }}. Have AI-image generated for 0.05 EUR in less than a minute‚û°Ô∏è" width="170" height="auto"></td>
                          {% if 'AI-Image' in item %}
                           <td contenteditable="false" data-column="AI-Image"><img src="{{ item['AI-Image'] }}" alt="AI-Image of {{ item['Item Name'] }}" width="170" height="auto"></td>
                           {% else %}
                           <td contenteditable="false" data-column="AI-Image"></td>
                           {% endif %}
                          <td><button class="delete-row-btn">Delete</button></td>
                          
                        </tr>
                        {% endfor %}
                        {% else %}
                        {% for item in html_menu_tuples %}
                        <tr>
                          <td contenteditable="false" data-column="Item Name" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Item Name"] }}</td>
                          <td contenteditable="false" data-column="Item Description" style="max-width: 300px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Item Description"] }}</td>
                          <td contenteditable="false" data-column="Item Price (EUR)" style="max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ item["Item Price (EUR)"] }}</td>
                          <td contenteditable="false" data-column="Link to Image" style="max-width: 200px; overflow-wrap: break-word; word-wrap: break-word; white-space: normal;">{{ item["Link to Image"] }}</td>
                          <td contenteditable="false" data-column="Image"><img src="{{ item['Link to Image'] }}" alt="Image of {{ item['Item Name'] }}" width="170" height="auto"></td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                  </table>

                  

                  <script>
                    // Add event listener to all delete buttons
                        document.querySelectorAll('.delete-row-btn').forEach(function(button) {
                            button.addEventListener('click', function() {
                                // Display confirmation dialog
                                let confirmation = confirm('Are you sure you want to delete this item?');
                                if (confirmation) {
                                    // If user clicks "Yes", delete the row
                                    let row = button.closest('tr');
                                    row.parentNode.removeChild(row);
                                } else {
                                    // If user clicks "No", do nothing
                                    return;
                                }
                            });
                        });

                        document.getElementById('exportCsvBtn').addEventListener('click', function() {
                            let table = document.getElementById('menuTable');
                            let csv = [];
                            let rows = table.querySelectorAll('tr');

                            // Loop over the rows of the table
                            for (let i = 0; i < rows.length; i++) {
                                let row = [];
                                let cols = rows[i].querySelectorAll('td, th');
                                
                                // Loop over the first 4 columns only
                                for (let j = 0; j < 4 && j < cols.length; j++) {
                                    row.push('"' + cols[j].innerText.replace(/"/g, '""') + '"'); // Escape any quotes inside the cell data
                                }

                                csv.push(row.join(','));
                            }

                            // Create a CSV string from the rows array
                            let csvString = csv.join('\n');

                            // Create a Blob object from the CSV string
                            let csvFile = new Blob([csvString], { type: 'text/csv' });

                            // Create a link element
                            let downloadLink = document.createElement('a');
                            downloadLink.download = 'menu.csv';

                            // Create a URL for the Blob and set it as the href of the link
                            downloadLink.href = window.URL.createObjectURL(csvFile);

                            // Append the link to the body
                            document.body.appendChild(downloadLink);

                            // Trigger the download by simulating a click
                            downloadLink.click();

                            // Remove the link from the document
                            document.body.removeChild(downloadLink);
                        });

                    
                        const appendGenerateImageButton = () => {
                        document.querySelectorAll('#menuTable tbody tr').forEach(function(row) {
                            // Find the cell that has 'data-column' equal to 'AI-Image'
                            row.querySelectorAll('td').forEach(function(cell) {
                                let dataColumn = cell.getAttribute('data-column');

                                // Check if the cell has the data-column 'AI-Image'
                                if (dataColumn === 'AI-Image') {
                                    // Check if the cell contains an image element
                                    let imgElement = cell.querySelector('img');

                                    // If no image element exists, append the "Generate Image" button
                                    if (!imgElement) {
                                        let aiImageButton = document.createElement('button');
                                        aiImageButton.innerText = 'Generate Image';
                                        aiImageButton.classList.add('generate-image-btn');
                                        cell.appendChild(aiImageButton);

                                        // Attach event listener to the generate button
                                        attachGenerateImageListener(aiImageButton, row);
                                    }
                                }
                            });
                        });
                    };

                    // Call the function
                    appendGenerateImageButton();



                        function attachGenerateImageListener(button, row) {
                            button.addEventListener('click', function() {
                                let itemName = row.querySelector('td[data-column="Item Name"]').innerText;
                                let itemDescription = row.querySelector('td[data-column="Item Description"]').innerText;
                                let aiImageCell = row.querySelector('td[data-column="AI-Image"]');
                                
                                // Show loading spinner
                                aiImageCell.innerHTML = '<img src="/static/assets/loading-gif.gif" width="50" alt="Loading...">';

                                // Send the name and description to generate the image
                                const triggerGenerateImage = (itemName, itemDescription, aiImageCell) => {
                                    // Send a request to start image generation
                                    fetch('/trigger_generate_menu_item_image', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            item_name: itemName,
                                            item_description: itemDescription
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.task_id) {
                                            // Poll the task status to get the generated image link
                                            checkTaskStatus(data.task_id, aiImageCell);
                                        } else {
                                            aiImageCell.innerHTML = 'Failed to start image generation';
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error initiating image generation:', error);
                                        aiImageCell.innerHTML = 'Error initiating image generation';
                                    });
                                };

                                // Poll the task status using the task ID
                                const checkTaskStatus = (task_id, aiImageCell) => {
                                    // Poll the status at intervals (e.g., every 2 seconds)
                                    const interval = setInterval(() => {
                                        fetch(`/generate_menu_item_image_status/${task_id}`, {
                                            method: 'GET'
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.state === 'SUCCESS') {
                                                // console.log(`Image Link: ${data.image_link}`)
                                                // Task completed, display the generated image
                                                aiImageCell.innerHTML = `<img src="${data.image_link}" alt="AI-Image of ${itemName}" width="170" height="auto">`;
                                                clearInterval(interval);  // Stop polling
                                            } else if (data.state === 'FAILURE') {
                                                // Handle failure
                                                aiImageCell.innerHTML = 'Failed to generate image';
                                                clearInterval(interval);  // Stop polling
                                            } else {
                                                // Task is still in progress (e.g., pending or retrying)
                                                aiImageCell.innerHTML = 'Generating image...';
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error checking task status:', error);
                                            aiImageCell.innerHTML = 'Error checking task status';
                                            clearInterval(interval);  // Stop polling on error
                                        });
                                    }, 2000);  // Poll every 2 seconds
                                };
                                // Trigger image generation
                                triggerGenerateImage(itemName, itemDescription, aiImageCell);
                        });
                    };


                    document.getElementById('addNewItemBtn').addEventListener('click', function() {
                    // Get the values from the form inputs
                    let itemName = document.getElementById('newItemName').value.trim();
                    let itemDescription = document.getElementById('newItemDescription').value.trim();
                    let itemPrice = document.getElementById('newItemPrice').value.trim();
                    let itemImageLink = document.getElementById('newItemImageLink').value.trim();

                    // Validation
                    if (!itemName || !itemDescription) {
                        alert('Item Name and Item Description are required and must be valid strings.');
                        return;
                    }

                    if (isNaN(itemPrice) || itemPrice <= 0) {
                        alert('Item Price must be a valid number greater than 0.');
                        return;
                    }

                    if (itemImageLink && !isValidUrl(itemImageLink)) {
                        alert('The Image Link must be a valid URL or leave it empty.');
                        return;
                    }

                    let newItem = {
                        "Item Name": itemName,
                        "Item Description": itemDescription,
                        "Item Price (EUR)": parseFloat(itemPrice).toFixed(2),
                        "Link to Image": itemImageLink,
                    };

                    // Add new item to the table
                    let table = document.getElementById('menuTable').getElementsByTagName('tbody')[0];
                    let newRow = table.insertRow(0);

                     style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                     
                    newRow.style.maxWidth = 200;
                    newRow.style.overflow = "hidden";
                    newRow.style.textOverflow = "ellipsis";
                    newRow.style.whiteSpace = "nowrap";

                    Object.keys(newItem).forEach(function(key) {
                        let cell = newRow.insertCell();
                        cell.style.maxWidth = "200px";  // Add "px" for width value
                        cell.style.overflow = "hidden";
                        cell.style.textOverflow = "ellipsis";
                        cell.style.whiteSpace = "nowrap";
                        cell.contentEditable = "true";  // This allows the content to be editable
                        cell.setAttribute('data-column', key);  // Sets a custom attribute 'data-column'
                        cell.textContent = newItem[key];  // Use textContent, faster and more consistent
                    });

                    let imgCell = newRow.insertCell();
                    imgCell.setAttribute('data-column', "Image");
                    if (newItem['Link to Image']) {
                        imgCell.innerHTML = '<img src="'+newItem['Link to Image']+'" alt="Image of '+newItem['Item Name']+'" width="170" height="auto">';
                    } else {
                        imgCell.innerText = 'No Image Provided';
                    }

                    let deleteButtonCell = newRow.insertCell();
                    deleteButtonCell.innerHTML = '<td><button class="delete-row-btn">Delete</button><p style="font-size: 10px; color: #00ff00">Newly added Item</p></td>'

                    // Reattach delete event listeners to all delete buttons
                    attachDeleteListeners();
                    
                    
                    // Clear all input fields in the form by looping through them
                    const inputs = document.querySelectorAll('#newItemForm input');
                    inputs.forEach(input => input.value = '');



                    appendGenerateImageButton();

                    });

                    function attachDeleteListeners() {
                        document.querySelectorAll('.delete-row-btn').forEach(function(button) {
                            button.addEventListener('click', function() {
                                let confirmation = confirm('Are you sure you want to delete this row?');
                                if (confirmation) {
                                    let row = button.closest('tr');
                                    row.parentNode.removeChild(row);
                                }
                            });
                        });
                    }

                    function attachDeleteOneByOneListeners() {
                        document.querySelectorAll('.delete-add-oneByOne-row-btn').forEach(function(button) {
                            button.addEventListener('click', function() {
                                let confirmation = confirm('Are you sure you want to delete this row?');
                                if (confirmation) {
                                    let row = button.closest('tr');
                                    row.parentNode.removeChild(row);
                                }
                            });
                        });
                    }

                    // Function to validate URL
                    function isValidUrl(string) {
                        try {
                            if (string) {
                                console.log("Entered URL")
                            new URL(string);
                            }
                            console.log("Returned True")
                            return true;
                        } catch (_) {
                            return false;
                        }
                    }


                    document.getElementById('saveChangesBtn').addEventListener('click', function() {
                        document.getElementById("loadingGif").style.display = "block"
                        
                        let rows = document.querySelectorAll('#menuTable tbody tr');
                        let updatedItems = [];

                        rows.forEach(function(row) {
                            let item = {};
                            row.querySelectorAll('td').forEach(function(cell) {
                                // For all columns except the image columns, store the cell's innerText
                                let dataColumn = cell.getAttribute('data-column');
                                if (dataColumn !== "Image" && dataColumn !== "AI-Image" && dataColumn !== null) {
                                    item[dataColumn] = cell.innerText;
                                } 
                                // Access the img src for the AI image column
                                else if(dataColumn === "AI-Image") {
                                    let imgElement = cell.querySelector('img');  // Find the img element inside the td
                                    if (imgElement) {
                                        item[dataColumn] = imgElement.src;  // Store the img src in the item object
                                    }
                                }
                            });
                            updatedItems.push(item);
                        });

                        const data_to_send = {
                            "unique_azz_id":"{{ unique_azz_id }}",
                            "updatedItems": updatedItems
                        }

                        fetch('/update_menu_manual', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data_to_send)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                location.reload();
                            }
                        });
                    });
                  </script>
            </div>
        </div>
        <hr>
    </div>
</body>
<script>
 document.addEventListener('DOMContentLoaded', function() {
 // Hide flash messages after 5 seconds
 var flashMessages = document.querySelector('.flash-messages');
  if (flashMessages) {
    setTimeout(function() {
      flashMessages.style.display = 'none';
    }, 5000);
  }
});
</script>   
{% endblock %}

