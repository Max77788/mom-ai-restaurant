{% extends 'layout_no_land.html' %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: flex-start;">
    <!-- Left Column: Form -->
    <div style="flex: 1; margin-right: 20px; text-align: center;">
        <h2>Setup your restaurant global profile</h2>
        <h4>So people from anywhere in the worldüåç can see YOUR restaurantüëÄ</h4>

        <form action="{{ url_for('setup_public_profile') }}" method="POST" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            
            <!-- Name -->
            <div>
                <label for="name">Name of Your Restaurant</label>
                {{ form.name(cols=50, rows=4, id='name-input', required=True) }}
                {% if form.name.errors %}
                    <span style="color: red;">{{ form.name.errors[0] }}</span>
                {% endif %}
            </div>
            
            <!-- Description -->
            <div>
                <label for="description">Description of your restaurant (50-350 characters):</label>
                {{ form.description(cols=50, rows=4, id='description-input', required=True) }}
                {% if form.description.errors %}
                    <span style="color: red;">{{ form.description.errors[0] }}</span>
                {% endif %}
            </div>

            <!-- Location Input-->
            <div class="form-group">
                <label for="location">Restaurant Location:</label>
                <div style="text-align: left; margin-bottom: 20px; display: flex; justify-content: center; align-items: left; flex-direction: column;">
                    <div style="display: flex; align-items: center; justify-content: flex-start; width: 100%; max-width: 400px;">
                        <input id="pac-input" class="controls form-control" type="text" placeholder="Enter a location" required>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Google_Maps_Logo_2020.svg/512px-Google_Maps_Logo_2020.svg.png" style="height:40px; width: auto; margin-left: 10px;">
                    </div>
                </div>
                <input type="hidden" id="locationInput" name="location" required>
                <input type="hidden" id="locationName" name="locationName" required>
            </div>
            
            <!-- Website URL (Optional) -->
            <div>
                <label for="website_url">Website URL of your restaurant (optional):</label>
                {{ form.website_url(size=50, id='website-url-input') }}
            </div>

            <!-- Logo (Optional) -->
            <div style="margin-bottom: 5px;">
                <label for="logo">Logo of your restaurant (optional):</label>
                {{ form.logo(id='logo-input') }}
                <p style="font-size: 14px;">The image should be square - for example, 1080x1080, 840x840</p>
            </div>

            <div class="form-group">
                <label for="email">*If someone invited you input their referral ID<br>(you both will earn from it):</label>
                {{ form.referral_id }}
            </div>

            <div style="margin-top: 10px;">
                <button type="submit" id="submit-button" disabled>Setup Public Profile</button>
            </div>

            
        </form>
    </div>

    <!-- Right Column: Dynamic Profile Preview -->
    <div style="flex: 1; border-left: 1px solid #ccc; padding-left: 20px; text-align: center;">
        <h3 style="margin-bottom: 10px;">Profile Preview</h3>
        <div id="profile-preview" style="text-align: center;">
            <div id="profile-logo" style="margin-bottom: 15px;">
                <img id="logo-preview" src="/static/images/Black Bold Initial AI Business Logo.png" alt="Restaurant Logo" style="max-width: 150px; max-height: 150px;">
            </div>
            <div id="profile-name" style="margin-bottom: 15px;">
                <h2 id="name-preview">Your Restaurant Name</h2>
            </div>
            <div id="profile-description" style="margin-bottom: 15px;">
                <p id="description-preview">This is where your restaurant description will appear. Make it appealing to attract customers!</p>
            </div>
            <div id="profile-website-url">
                <a id="website-url-preview" href="#" target="_blank">www.your-restaurant.com</a>
            </div>

            
        </div>
    </div>
</div>

<!-- JavaScript for live updating the preview -->
<script>
    // Description Update
    document.getElementById('description-input').oninput = function() {
        document.getElementById('description-preview').textContent = this.value || 'This is where your restaurant description will appear. Make it appealing to attract customers!';
    };

    // Description Update
    document.getElementById('name-input').oninput = function() {
        document.getElementById('name-preview').textContent = this.value || 'Your Restaurant Name';
    };



    // Website URL Update
    document.getElementById('website-url-input').oninput = function() {
        const previewElement = document.getElementById('website-url-preview');
        previewElement.textContent = this.value || 'www.your-restaurant.com';
        previewElement.href = this.value || '#';
    };

    // Logo Update
    document.getElementById('logo-input').onchange = function(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const logoPreview = document.getElementById('logo-preview');
            logoPreview.src = e.target.result;
        };
        if (file) {
            reader.readAsDataURL(file);
        } else {
            document.getElementById('logo-preview').src = 'https://i.ibb.co/fD13tSj/Black-Bold-Initial-AI-Business-Logo.png';
        }
    };


    function initAutocomplete() {
    const input = document.getElementById('pac-input');
    const autocomplete = new google.maps.places.Autocomplete(input);

    // Autocomplete select listener
    autocomplete.addListener('place_changed', function() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
            console.log("Place details not found for input: " + input.value);
            return;
        }

        const formattedAddress = formatAddressWithCity(place);
        updateLocation(place.geometry.location, formattedAddress);
    });
}

function formatAddressWithCity(place) {
    let addressComponents = place.address_components;
    let street = '', buildingNumber = '', city = '', region = '', country = '';

    addressComponents.forEach(component => {
        if (component.types.includes('route')) {
            street = component.long_name;
        }
        if (component.types.includes('street_number')) {
            buildingNumber = component.long_name;
        }
        if (component.types.includes('locality')) {
            city = component.long_name;
        }
        if (component.types.includes('administrative_area_level_1')) {
            region = component.long_name;
        }
        if (component.types.includes('country')) {
            country = component.long_name;
        }
    });

    let formattedAddress = '';
    if (buildingNumber && street) {
        formattedAddress += buildingNumber + ' ' + street;
    } else if (street) {
        formattedAddress += street;
    }
    if (city) {
        formattedAddress += ', ' + city;
    }
    if (region) {
        formattedAddress += ', ' + region;
    }
    if (country) {
        formattedAddress += ', ' + country;
    }

    // Ensure that required components are present
    if (!street || !city || !country) {
        alert("Please select a valid location including street, city, and country.");
        return '';
    }

    return formattedAddress;
}

function updateLocation(position, formattedAddress) {
    if (formattedAddress) {
        document.getElementById('locationInput').value = JSON.stringify(position);
        document.getElementById('locationName').value = formattedAddress;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const submitButton = document.getElementById('submit-button');
    const requiredFields = [
        document.getElementById('name-input'),
        document.getElementById('description-input'),
        document.getElementById('locationInput'),
        document.getElementById('locationName'),
        // Add other fields as necessary
    ];

    // Function to check if all required fields are filled
    function checkFormValidity() {
        const allValid = requiredFields.every(field => field.value.trim() !== '');
        const minimum_50 = document.getElementById('description-input').value.length >= 50
        submitButton.disabled = !(allValid && minimum_50);
    }

    // Attach input event listeners to required fields
    requiredFields.forEach(field => {
        field.addEventListener('input', checkFormValidity);
    });

    // Also attach event listener for the Google Places autocomplete (location field)
    const pacInput = document.getElementById('pac-input');
    pacInput.addEventListener('input', checkFormValidity);

    // Ensure form is valid on page load
    checkFormValidity();
});



</script>

<!-- Include Google Maps JavaScript API with Places library -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete" async defer></script>
{% endblock %}
