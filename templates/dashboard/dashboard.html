{% extends 'layout_dashboard.html' %}

{% block content %}

{% if show_popup %}
<!-- Popup message container -->
<div id="popup-message" class="popup">
    <div class="popup-content">
        <span class="close-button">&times;</span>
        <h1>Congratulations!</h1>
        <!--
        <h2>‚úÖYour Account Has Been Successfully Created‚úÖ</h2>
        <p>You can setup the features you have not so far on the dashboard in "Profile" section</p>
        <p>As long as you have provided your restaurant's menu(if not yet), you can start earning money with MOM AI Restaurant</p>
        
        <h3>Next Steps:</h3>
        <h2 style="margin-top: 10px;">1. Setup Notifications in 30 secondsüîî</h2>
        <p>- Visit <a href="https://t.me/mom_ai_rest_bot" target="_blank"><u>MOM AI Restaurant Bot</u></a> in Telegram and copy received code</p>
        <p>- Go to Profile -> Notifications section and paste the obtained code</p>
        <p>- Now you will be receiving the notification upon the incoming of the order</p>
        <p><i>*you can set up notifications on the multiple devices (e.g., on your phone and the ones of employees)</i></p>
        <h2 style="margin-top: 10px;">2. Set the working hours of your restaurant‚è±Ô∏è</h2>
        <p>- Go to Profile -> <a href="/set-working-hours" target="_blank"><u>Set Working Hours</u></a> section and press 'Edit' button</p>
        <p>- Choose your restaurant's timezone and working hours, press 'Submit' button</p>
        <h2 style="margin-top: 10px;">3. Form and upload your restaurant menu quicklyüìë</h2>
        <p>- Go to Menu section and check out the simple instructions on how to upload your menu.</p>
        <p><a href="https://chatgpt.com/g/g-CJCHfiKMQ-mom-ai-restaurant-assistant" target="_blank" style="margin-top:20px; margin-bottom: 20px;"><u>Talk to MOM AI GPT and have your menu file formed!</u></a></p>
        <h2 style="margin-top: 10px;">4. Activate the assistant in right upper corner<br>&<br>begin generating orders with MOM AI Restaurantüìà</h2>
        <img src="/static/images/turn_on_ass.png" alt="Turn On Assistant" style="max-width: 100%; height: auto;">
        <p>*you can check out this guide anytime at the bottom of the dashboard page‚ôªÔ∏è</p>
        -->
        <h2>Happy Earningüí≤ and Welcome to the Futureüõ∞Ô∏è</h2>
    </div>
</div>

<!-- Add the CSS styles for the popup -->
<style>
.popup {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
}

.popup-content {
    background-color: #fff;
    margin: 10% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 8px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.close-button {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close-button:hover,
.close-button:focus {
    color: #000;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

<!-- Add the JavaScript to control the popup -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Check for 'show_popup' in the URL and remove it
    const url = new URL(window.location.href);
    if (url.searchParams.has('show_popup')) {
        url.searchParams.delete('show_popup');
        window.history.replaceState({}, document.title, url.toString());
    }
    
    var popup = document.getElementById('popup-message');
    var closeButton = document.getElementsByClassName('close-button')[0];

    popup.style.display = 'block';

    closeButton.onclick = function() {
        popup.style.display = 'none';
    };

    window.onclick = function(event) {
        if (event.target == popup) {
            popup.style.display = 'none';
        }
    };
});

function downloadImage() {
        html2canvas(document.getElementById('qr-code-container')).then(canvas => {
            var link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'qr-code.png';
            link.click();
        });
    }
</script>
{% endif %}

<div class="dashboard">
    <div class="dashboard-header">
        <div class="total-earned">
            <span><strong>Available Funds:</strong> {{ current_balance }} {{ res_currency }}</span>
            <hr>
            <span><strong>Spent on Assistant:</strong> {{ assistant_spent }} {{ res_currency }}</span>
            <hr>
            <a href="/withdraw-funds" class="withdraw-button" target="_blank"><i><u>Withdraw Funds</u></i></a>
            {% if awaiting_withdrawal > 0 %}
            <span><strong>Awaiting Withdrawal:</strong> {{ awaiting_withdrawal }}</span> EUR
            {% endif %}
            <hr>
            <i><a href="javascript:void(0);" onclick="toggleVisibilityAndConvert('currency-converter', '{{ res_currency }}');"><u>Show/Hide Currency Converter</u></a></i>
            <hr>
            <div id="currency-converter" style="display: none;">
                <p style="font-size: 18px;">Available Funds of <b>{{ current_balance }} {{ res_currency }}</b> in other currencies:</p>
                <span id="available-funds" style="display: none;">{{ current_balance }}</span>
        
                <div class="results">
                    <b><p>USD($): <span id="usd"></span></p></b>
                    <b><p>UAH(‚Ç¥): <span id="uah"></span></p></b>
                    <b><p>ISK(kr): <span id="isk"></span></p></b>
                </div>
            </div>
            <!-- Custom button to activate PayPal button and input field -->
            <div style="margin-top: 10px;">
                <button id="activate-paypal-button" class="btn btn-primary">Top Up the Balanceüìà</button>
            </div>
            <hr>
            <p>Your Referral ID - <b>{{ referral_id }}</b></p>
            <p style="font-size: 12px;">(give it to a new restaurant and earn passively!)</p>
            {% if num_of_referees > 0 %}
            <hr>
            <div style="font-size: 10px;">
            <p>Bravo, your restaurant is earning passivelyüí∏</p>
            <p><b>{{ num_of_referees }} restaurants have registered with your code</b></p>
            </div>
            {% endif %}
        </div>
        
        <!-- Include the PayPal JavaScript SDK -->
        <script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=EUR"></script>
        
        <!-- Styles for the modal -->
        <style>
            .modal {
                display: none;
                position: fixed;
                z-index: 1;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgb(0,0,0);
                background-color: rgba(0,0,0,0.4);
            }
        
            .modal-content {
                background-color: #fefefe;
                margin: 15% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 600px;
            }
        
            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
            }
        
            .close:hover,
            .close:focus {
                color: black;
                text-decoration: none;
                cursor: pointer;
            }
        </style>
        
        <script>
            document.getElementById('activate-paypal-button').addEventListener('click', function() {
                // Display the modal
                var modal = document.getElementById('paypal-modal');
                modal.style.display = 'block';
        
                // Clear any previously rendered PayPal buttons
                var paypalButtonContainer = document.getElementById('paypal-button-container');
                paypalButtonContainer.innerHTML = '';
        
                paypal.Buttons({
                    style: {
                        size: 'small', // small | medium | large | responsive
                        shape: 'pill', // rect | pill
                        color: 'silver', // gold | blue | silver | black
                        label: 'paypal', // paypal | checkout | buynow | pay | installment
                        tagline: false // Show the tagline text at the bottom
                    },
                    // Call your server to set up the transaction
                    createOrder: function(data, actions) {
                        const totalToPay = document.getElementById('top-up-amount').value;
                        return fetch('/create_order', {
                            method: 'post',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ total_to_pay: totalToPay })
                        }).then(function(res) {
                            return res.json();
                        }).then(function(orderData) {
                            return orderData.id;
                        }).catch(function(error) {
                            console.error('Error:', error);  // Handle any errors
                        });
                    },
                    // Call your server to finalize the transaction
                    onApprove: function(data, actions) {
                        const totalToPay = document.getElementById('top-up-amount').value;
                        const unique_azz_id = "{{ res_unique_azz_id }}";

                        return fetch(`/capture_order/${data.orderID}?top-up-balance=yes&unique_azz_id=${unique_azz_id}&amount=${totalToPay}`, {
                            method: 'post'
                        }).then(function(res) {
                            console.log("1")
                            return res.json();
                        }).then(function(orderData) {
                            console.log("2")
                            var errorDetail = Array.isArray(orderData.details) && orderData.details[0];
                            if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                                return actions.restart(); // Recoverable state
                            }
                            console.log("3")
                            if (errorDetail) {
                                var msg = 'Sorry, your transaction could not be processed.';
                                if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                                if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                                return alert(msg); // Show a failure message
                            }
                            console.log("4")
                            // var transaction = orderData.purchase_units[0].payments.captures[0];
                            // const unique_azz_id = "{{ unique_azz_id }}";
                            console.log("5")
                            console.log("Order Data itself: ", orderData)
                            if (orderData.topped_up_balance_manual){
                                console.log("6")
                                // This will reload the current page
                                location.reload();
                                return;
                            } 
                            // window.location.href = `/success_payment_backend/${unique_azz_id}`;
                            // alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');
                        });
                    }
                }).render('#paypal-button-container');
            });
            
            const paypalModal = document.querySelector('.close'); 

            // Close the modal
            paypalModal.addEventListener('click', function() {
                document.getElementById('paypal-modal').style.display = 'none';
            });
        </script>


        <div class="wallet-address">
            <h1 style="text-align: center;">Welcome,<br>{{ restaurant_name.replace("_"," ") }}!</h1>
        </div>
        <div class="restaurant-name">
            <span><strong>Your Email: </strong>{{ restaurant_email }}</span>
            {% if not is_google_acc %}
            <div>
            <a href="/set_session_and_redirect"><u>Change Email or Password</u></a>
            </div>
            {% endif %}
            <hr>
            <div>
                <a href="https://connect.squareup.com/oauth2/authorize?client_id={{ SQUARE_APP_ID }}&scope=CUSTOMERS_WRITE+CUSTOMERS_READ&session=false&redirect_uri={{ SQUARE_APP_REDIRECT_URI }}" target="_blank"><u>Connect Square POS</u></a>
                </div>
            <hr>
            <div class="logout-section">
                <form action="/logout" method="post">
                    <button type="submit">Logout</button>
                </form>
            </div>
            <hr>
            <div class="switch-container">
                {% if restaurant.menu_vector_id != "vector_is_not_yet" %}
                <span id="assistantStatus">
                    {% if not default_menu %}
                        {% if assistant_turned_on and current_balanceHigherThanTwentyCents %}
                        Assistant is ON<br><p style="font-size:0.7em"><i>*the assistant is currently taking orders<br><strong><a href="/set-working-hours" target="_blank">during the working hours</a></strong></i></p>
                        {% else %}
                            {% if not current_balanceHigherThanTwentyCents %}
                            <span style="text-decoration: underline; text-decoration-color: red;">Assistant is OFF</span><br><p style="font-size:0.7em"><i>*the assistant is currently<br><b>NOT</b> taking orders</i><br><b>TOP UP THE BALANCE NOW!</b></p>
                            {% else %}
                            <span style="text-decoration: underline; text-decoration-color: red;">Assistant is OFF</span><br><p style="font-size:0.7em"><i>*the assistant is currently<br><b>NOT</b> taking orders</i></p>
                            {% endif %}
                        {% endif %}
                    {% else %}
                    <span id="assistantStatus">
                        Please, visit <b>"Menuüìñ"</b> tab to upload menu<br>and start using AI-assistant
                    </span>
                    {% endif %}
                        
                </span>
                {% if not default_menu %}
                <label class="switch">
                    <input type="checkbox" id="assistantToggle" {% if assistant_turned_on and current_balanceHigherThanTwentyCents %}checked{% endif %}
                    {% if not current_balanceHigherThanTwentyCents %}disabled{% endif %}>
                    {% if not not current_balanceHigherThanTwentyCents %}
                    <span class="slider round"></span>
                    {% else %}
                    <span class="slider-disabled round"></span>
                    {% endif %}
                </label>
                {% endif %}
                {% else %}
                <span id="assistantStatus">
                    Please, visit <b>"Menuüìñ"</b> tab to upload menu<br>and start using AI-assistant
                </span>
                {% endif %}
            </div>
            <hr>
            <!--
            {% if default_menu %}
                <hr>
                <div class="default_menu">
                    <p style="font-size: medium;">AI-Assistant currently deos not have a menu to refer to.<br><b>Check out the "Menuüìñ" Tab Now!</b></p>
                </div>
                <hr>
            {% endif %}
            -->
            {% if not default_menu %}
            <div class="switch-container">
                <span id="discoveryModeStatus">
                    {% if restaurant.discovery_mode %}
                    Discovery Mode is ON<br><p style="font-size:0.7em"><i>*Assistant DOES NOT Take orders now<br>your assistant only chat with a customer</i></p>
                    {% else %}
                    Discovery Mode is OFF<br><p style="font-size:0.7em"><i>*Assistant takes orders now<br>and notifies you upon registration</i></p>
                    {% endif %}
                </span>
                <label class="switch">
                    <input type="checkbox" id="discoveryModeToggle" {% if restaurant.discovery_mode %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
            <hr>
            
            <div class="switch-container">
                <span id="profileVisibilityStatus">
                    {% if restaurant.profile_visible %}
                    Profile is VISIBLE<br><p style="font-size:0.7em"><i>*users currently <b>CAN</b> find your profile<br>on <a href="/ai-restaurants" target="_blank"><u>AI-restaurants platform</u></a></i></p>
                    {% else %}
                    Profile is HIDDEN<br><p style="font-size:0.7em"><i>*users currently <b>CANNOT</b> find your profile<br>on <a href="/ai-restaurants" target="_blank"><u>AI-restaurants platform</u></a></i></p>
                    {% endif %}
                </span>
                <label class="switch">
                    <input type="checkbox" id="profileVisibilityToggle" {% if restaurant.profile_visible %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
            </div>
            
            <hr>
          
        {% if discovery_mode %}
        <div style="display:none" id="paymentAndFeeDiv">
        {% else %}
        <div style="display:block" id="paymentAndFeeDiv">
        {% endif %}
        <div id="delivery-offered-toggle" class="switch-container">
            <span id="deliveryOfferedStatus">
                {% if delivery_offered %}
                Delivery Option is ON<br><p style="font-size:0.7em"><i>*currently users CAN order delivery</i></p>
                {% else %}
                Delivery Option is OFF<br><p style="font-size:0.7em"><i>*currently users CANNOT order delivery</i></p>
                {% endif %}
            </span>
        
            <label class="switch">
                <input type="checkbox" id="deliveryOfferedToggle" {% if delivery_offered %}checked{% endif %}>
                <span class="slider round"></span>
            </label>
        
            
        </div>

        {% if delivery_offered %}
            <!-- Adding the input field for delivery radius -->
            <div id="deliveryRadiusInputContainer" style="clear: both; margin-top: 10px; display: block; width: 100%;">
                <label for="deliveryRadius" style="display: block;">Delivery Radius (km):</label>
                <input type="number" id="deliveryRadiusInput" name="deliveryRadius" min="1" max="100" step="1" value="{% if delivery_radius %}{{ delivery_radius }}{% else %}10{% endif %}" style="display: block; width: auto;">
                <small style="display: block;"><i>*This is the radius in kilometers within which your restaurant provides delivery</i></small>
            </div>
        {% endif %}
        
        
           
        <hr>
            <div id="payment-gateway-toggler" class="switch-container">
                <span id="paymentGatewayStatus">
                    {% if gateway_is_on %}
                    Payment Gateway is ON<br><p style="font-size:0.7em"><i>*currently the orders are being registered when the customer paid</i></p>
                    {% else %}
                    Payment Gateway is OFF<br><p style="font-size:0.7em"><i>*currently customer DOES NOT pay right after taking the order,<br><b>recommended to switch the payment gateway on</b></i></p>
                    {% endif %}
                </span>
                {% if not default_menu %}
                <label class="switch">
                    <input type="checkbox" id="paymentGatewayToggle" {% if gateway_is_on %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
                {% endif %}
            </div>
            <hr>
            {% if gateway_is_on %}
            <div id="addFeesSection" class="switch-container">
                {% else %}
                <div id="addFeesSection" class="switch-container" style="display: none;">
                    {% endif %}
                    <span id="addFeeToPaymentStatus">
                        {% if restaurant.addFees %}
                        <b>Customer</b> pays fee<br><p style="font-size:0.7em"><i>
                            MOM AI fee and PayPal fee (0.45‚Ç¨ + 4.49%)<br>are added to the customer payment</i></p>
                        {% else %}
                        <b>Restaurant</b> pays fee<br><p style="font-size:0.7em"><i>
                            MOM AI fee and PayPal fee (0.45‚Ç¨ + 4.49%)<br>are NOT added to the customer payment. <u>YOU PAY FEE NOW</u></i></p>
                        {% endif %}
                    </span>
                    <label class="switch">
                        <input type="checkbox" id="addFeeToPaymentToggle" {% if restaurant.addFees %}checked{% endif %}>
                        <span class="slider round"></span>
                    </label>
                </div>
                {% endif %}

                
            </div>
        </div>
    </div>
    
    

    <nav class="dashboard-nav">
        <a href="/payments" class="no-right-click-tab">Paymentsüí∞</a>
        <a href="/menu" class="no-right-click-tab">Menuüìñ</a>
        <a href="/assistant_dash" class="no-right-click-tab">Assistantü§ñ</a>
        <a href="/profile" class="no-right-click-tab">Profileüö¢</a>
        <a href="/view_orders" class="tab" target="_blank">Orders Displayüì∫</a>
    </nav>

    <section class="dynamic-content" id="dynamic-content">
        <!-- Content will be dynamically loaded here based on the tab chosen -->
    </section>

    <div id="explanatoryInfo">
        <h4>What do you want?</h4>
        <ol>
            <li>
                <i>"I want to SEE the HISTORY of MADE PAYMENTS"</i> - Click on the <b>Payments</b> tab
            </li>
            <hr>
            <li>
                <i>"I want to know WHAT IS THE CURRENT MENU the assistant refers to and, probably, UPDATE it"</i> - Click on the <b>Menu</b> tab
            </li>
            <hr>
            <li>
                <i>"I want to actually <b>start using assistant</b> and integrate it with my restaurant"</i> - Click on the <b>Assistant</b> tab
            </li>
            <hr>
            <li>
                <i>"I want to MODIFY MY PROFILE and SETUP THE NOTIFICATIONS to receive on incoming orders"</i> - Click on the <b>Profile</b> tab
            </li>
            <hr>
            <li>
                <i>"I want to OPEN THE DASHBOARD with taken orders displayed"</i> - Click on the <b>View Orders</b> tab
            </li>
        </ol>
        <!--
        <h3><a href="/dashboard?show_popup=True"><u>Check out the setup guide</u></a></h3>
        -->
    </div>

    <style>
        .dashboard-header, .dashboard-nav, .dynamic-content, .flash-messages, #explanatoryInfo {
            padding: 1px;
            margin-bottom: 5px;
        }

        .switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 7px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider-disabled {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        #explanatoryInfo {
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            font-family: Arial, sans-serif;
        }

        #explanatoryInfo h4 {
            margin-top: 35px;
            color: #333;
        }

        #explanatoryInfo ol {
            list-style-type: none;
            padding-left: 0;
        }

        #explanatoryInfo li {
            margin-bottom: 20px;
        }

        #explanatoryInfo hr {
            border: none;
            border-top: 1px solid #ccc;
        }

        #explanatoryInfo h3 a {
            color: #007bff;
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .dashboard-header, .dashboard-nav, .dynamic-content, .flash-messages, #explanatoryInfo {
                padding: 10px;
                margin-bottom: 15px;
            }

            .popup-content {
                width: 90%;
                max-width: 400px;
            }

            .switch-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .switch {
                margin-top: 10px;
            }
        }
    </style>

    <!-- Modal container -->
    <div id="paypal-modal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">&times;</span>
            <div>
                <label for="top-up-amount"><strong>Top Up Amount (in Euros):</strong></label>
                <input type="number" id="top-up-amount" value="50" min="10" step="1" style="width: 200px;">
            </div>
            <div id="paypal-button-container" style="margin-top: 10px;"></div>
        </div>
    </div>

    <script>
        // Get the close button element
        const closeButton = document.getElementById("closeModal");

        // Function to close the modal
        closeButton.onclick = function() {
            document.getElementById("paypal-modal").style.display = "none";
        };
                
        // Other currencies display
        function toggleVisibilityAndConvert(id, baseCurrency) {
            const element = document.getElementById(id);
            if (element.style.display === "none") {
                element.style.display = "block";
                convertCurrency(baseCurrency);
            } else {
                element.style.display = "none";
            }
        }

        async function convertCurrency(baseCurrency) {
            const amount = parseFloat(document.getElementById('available-funds').innerText);
            const api_key = '{{ exchange_api_key }}';

            if (isNaN(amount) || amount <= 0) {
                alert('Invalid amount for available funds.');
                return;
            }

            try {
                const response = await fetch(`https://v6.exchangerate-api.com/v6/${api_key}/latest/${baseCurrency}`);
                const data = await response.json();

                if (data.result === "success") {
                    const rates = data.conversion_rates;
                    const amountInUAH = (amount * rates.UAH).toFixed(2);
                    const amountInISK = (amount * rates.ISK).toFixed(2);
                    const amountInUSD = (amount * rates.USD).toFixed(2);

                    document.getElementById('uah').innerText = amountInUAH + ' (Ukrainian Hryvnias)';
                    document.getElementById('isk').innerText = amountInISK + ' (Icelandic Kronas)';
                    document.getElementById('usd').innerText = amountInUSD + ' (US Dollars)';
                } else {
                    alert('Failed to fetch exchange rates. Please try again later.');
                }
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                alert('Failed to fetch exchange rates. Please try again later.');
            }
        }

        // Function to send the radius value to the server
        function sendRadiusValue(radiusValue) {
            fetch('/delivery_offered_toggler', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json' // If you are using CSRF tokens
                },
                body: JSON.stringify({
                    radius: radiusValue
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Radius value successfully sent');
                } else {
                    console.error('Failed to send radius value');
                }
            })
            .catch(error => {
                console.error('Error sending radius value:', error);
            });
        };

        document.addEventListener('DOMContentLoaded', function() {
            const radiusInputElement = document.getElementById("deliveryRadiusInput");

            if (radiusInputElement){
            radiusInputElement.addEventListener('input', function() {
                    sendRadiusValue(radiusInputElement.value);
                });
            };

            var tabs = document.querySelectorAll('.no-right-click-tab');

            function loadTabContent(event) {
                event.preventDefault();

                var url = event.currentTarget.getAttribute('href');

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('dynamic-content').innerHTML = html;
                    })
                    .catch(error => {
                        document.getElementById('dynamic-content').innerHTML = '<p>Error loading content...</p>';
                    });
            }

            tabs.forEach(tab => {
                tab.addEventListener('click', loadTabContent);
                tab.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                });
            });

            // Get reference to the checkbox and parent container
        const deliveryOfferedToggle = document.getElementById('deliveryOfferedToggle');
        const parentContainer = document.getElementById('delivery-offered-toggle'); // Parent container to append after

        // Function to create and insert the delivery radius input container if it doesn't exist
        function createDeliveryRadiusInput() {
            // Check if the element already exists
            let deliveryRadiusInputContainer = document.getElementById('deliveryRadiusInputContainer');
            
            if (!deliveryRadiusInputContainer) {
                // If it doesn't exist, create it
                deliveryRadiusInputContainer = document.createElement('div');
                deliveryRadiusInputContainer.id = 'deliveryRadiusInputContainer';
                deliveryRadiusInputContainer.style.marginTop = '10px';
                deliveryRadiusInputContainer.style.display = 'block';
                
                // Create the label element
                const label = document.createElement('label');
                label.htmlFor = 'deliveryRadius';
                label.textContent = 'Delivery Radius (km):';
                label.style.display = 'block';

                // Create the input element
                const input = document.createElement('input');
                input.type = 'number';
                input.id = 'deliveryRadiusInput';
                input.name = 'deliveryRadius';
                input.min = '1';
                input.max = '100';
                input.step = '1';
                input.value = '{{ delivery_radius }}'; // Default value, you can change it as needed
                input.style.display = 'block';
                input.style.width = 'auto';

                // Add event listener to send the value when changed
                input.addEventListener('input', function() {
                    sendRadiusValue(input.value);
                });

                // Create the small explanation text
                const smallText = document.createElement('small');
                smallText.style.display = 'block';
                smallText.innerHTML = '<i>*This is the radius in kilometers within which your restaurant provides delivery</i>';

                // Append label, input, and small text to the container
                deliveryRadiusInputContainer.appendChild(label);
                deliveryRadiusInputContainer.appendChild(input);
                deliveryRadiusInputContainer.appendChild(smallText);

                // Insert the container after the parent container
                parentContainer.insertAdjacentElement('afterend', deliveryRadiusInputContainer);
            } else {
                // If it already exists, just ensure it's visible
                deliveryRadiusInputContainer.style.display = 'block';
            }
        }

        // Function to toggle the visibility of the delivery radius input container
        function toggleDeliveryRadiusInput() {
            if (deliveryOfferedToggle.checked) {
                // Create and show the element if the toggle is checked
                createDeliveryRadiusInput();
            } else {
                // Hide the element if it's unchecked
                const deliveryRadiusInputContainer = document.getElementById('deliveryRadiusInputContainer');
                if (deliveryRadiusInputContainer) {
                    deliveryRadiusInputContainer.style.display = 'none';
                }
            }
        }

        // Attach event listener to the checkbox to detect changes
        deliveryOfferedToggle.addEventListener('change', toggleDeliveryRadiusInput);

        // Run the function initially to ensure the correct state is set on page load
        toggleDeliveryRadiusInput();

        // Function to toggle the visibility of the delivery radius input container
        function toggleDeliveryRadiusInput() {
            if (deliveryOfferedToggle.checked) {
                // Create and show the element if the toggle is checked
                createDeliveryRadiusInput();
            } else {
                // Hide the element if it's unchecked
                const deliveryRadiusInputContainer = document.getElementById('deliveryRadiusInputContainer');
                if (deliveryRadiusInputContainer) {
                    deliveryRadiusInputContainer.style.display = 'none';
                }
            }
        }

        // Attach event listener to the checkbox to detect changes
        deliveryOfferedToggle.addEventListener('change', toggleDeliveryRadiusInput);

        // Run the function initially to ensure the correct state is set on page load
        toggleDeliveryRadiusInput();
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            const paymentGatewayToggle = document.getElementById('paymentGatewayToggle');
            const paymentGatewayStatus = document.getElementById('paymentGatewayStatus');
            const addFeesSectionDiv = document.getElementById("addFeesSection")


            if (paymentGatewayToggle) {
                paymentGatewayToggle.addEventListener('change', function() {
                    console.log("Toggling...")
                    var paymentGatewayTurnedOn = this.checked;

                    if (paymentGatewayTurnedOn) {
                        paymentGatewayStatus.innerHTML = 'Payment Gateway is ON<br><p style="font-size:0.7em"><i>*currently the orders are being registered when the customer paid</i></p>';
                        addFeesSectionDiv.style.display = 'flex';
                    } else {
                        paymentGatewayStatus.innerHTML = 'Payment Gateway is OFF<br><p style="font-size:0.7em"><i>*currently customer DOES NOT pay right after taking the order,<br><b>recommended to switch the payment gateway on</b></i></p>';
                        addFeesSectionDiv.style.display = 'none';
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/payment_gateway_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Payment Gateway state updated successfully.');
                            } else {
                                console.error('Error updating Payment Gateway state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ payment_gateway_turned_on: paymentGatewayTurnedOn }));
                });
            };

            const deliveryOfferedToggle = document.getElementById('deliveryOfferedToggle');
            const deliveryOfferedStatus = document.getElementById('deliveryOfferedStatus');
            const deliveryRadiusInput = document.getElementById('deliveryRadiusInput');

            if (deliveryOfferedToggle) {
                deliveryOfferedToggle.addEventListener('change', function() {
                    console.log("Toggling...")
                    var deliveryOfferedTurnedOn = this.checked;

                    if (deliveryOfferedTurnedOn) {
                        deliveryOfferedStatus.innerHTML = 'Delivery Option is ON<br><p style="font-size:0.7em"><i>*currently users CAN order delivery</i></p>';
                        
                    } else {
                        deliveryOfferedStatus.innerHTML = 'Delivery Option is OFF<br><p style="font-size:0.7em"><i>*currently users CANNOT order delivery</i></p>';
                        
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/delivery_offered_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Delivery offered state updated successfully.');
                            } else {
                                console.error('Error updating Delivery offered state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ delivery_offered_turned_on: deliveryOfferedTurnedOn }));
                });
            };


            const toggle = document.getElementById('assistantToggle');
            const statusLabel = document.getElementById('assistantStatus');

            if (toggle) {
                toggle.addEventListener('change', function() {
                    var assistantTurnedOn = this.checked;

                    if (assistantTurnedOn) {
                        statusLabel.innerHTML = 'Assistant is ON<br><p style="font-size:0.7em"><i>*the assistant is currently taking orders<br><strong><a href="/set-working-hours" target="_blank">during the working hours</a></strong></i></p>';
                    } else {
                        statusLabel.innerHTML = '<span style="text-decoration: underline; text-decoration-color: red;">Assistant is OFF</span><br><p style="font-size:0.7em"><i>*the assistant is currently<br><b>NOT</b> taking orders</i></p>';
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/assistant_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Assistant state updated successfully.');
                            } else {
                                console.error('Error updating assistant state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ assistant_turned_on: assistantTurnedOn }));
                });
            }

            const profileVisibilityToggle = document.getElementById('profileVisibilityToggle');
            const profileVisibilityStatus = document.getElementById('profileVisibilityStatus');

            if (profileVisibilityToggle) {
                profileVisibilityToggle.addEventListener('change', function() {
                    var profileVisible = this.checked;

                    if (profileVisible) {
                        profileVisibilityStatus.innerHTML = 'Profile is VISIBLE<br><p style="font-size:0.7em"><i>*users currently <b>CAN</b> find your profile<br>on <a href="/ai-restaurants" target="_blank"><u>AI-restaurants platform</u></a></i></p>';
                    } else {
                        profileVisibilityStatus.innerHTML = 'Profile is HIDDEN<br><p style="font-size:0.7em"><i>*users currently <b>CANNOT</b> find your profile<br>on <a href="/ai-restaurants" target="_blank"><u>AI-restaurants platform</u></a></i></p>';
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/profile_visibility_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Profile visibility state updated successfully.');
                            } else {
                                console.error('Error updating profile visibility state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ profile_visible: profileVisible }));
                });
            }

            const addFeeToPaymentToggle = document.getElementById('addFeeToPaymentToggle');
            const addFeeToPaymentStatus = document.getElementById('addFeeToPaymentStatus');

            if (addFeeToPaymentToggle) {
                addFeeToPaymentToggle.addEventListener('change', function() {
                    var addFeeToPayment = this.checked;

                    if (addFeeToPayment) {
                        addFeeToPaymentStatus.innerHTML = '<b>Customer</b> pays fee<br><p style="font-size:0.7em"><i>MOM AI fee and PayPal fee (0.45‚Ç¨ + 4.49%)<br>are added to the customer payment</i></p>';
                    } else {
                        addFeeToPaymentStatus.innerHTML = '<b>Restaurant</b> pays fee<br><p style="font-size:0.7em"><i>MOM AI fee and PayPal fee (0.45‚Ç¨ + 4.49%)<br>are NOT added to the customer payment. <u>YOU PAY FEE NOW</u></i></p>';
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/add_fee_payment_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Add fee to payment state updated successfully.');
                            } else {
                                console.error('Error updating add fee to payment state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ add_fee_payment: addFeeToPayment }));
                });
            }


            const discoveryModeToggle = document.getElementById('discoveryModeToggle');
            const discoveryModeStatus = document.getElementById('discoveryModeStatus');

            if (discoveryModeToggle) {
                discoveryModeToggle.addEventListener('change', function() {
                    var discovery_mode = this.checked;

                    if (discovery_mode) {
                        discoveryModeStatus.innerHTML = 'Discovery Mode is ON<br><p style="font-size:0.7em"><i>*Assistant DOES NOT Take orders now<br>your assistant only chat with a customer</i></p>'
                        document.getElementById("paymentAndFeeDiv").style.display = 'none';

                    } else {
                        discoveryModeStatus.innerHTML = 'Discovery Mode is OFF<br><p style="font-size:0.7em"><i>*Assistant takes orders now<br>and notifies you upon registration</i></p>';
                        document.getElementById("paymentAndFeeDiv").style.display = 'block';
                    }

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', '/discovery_mode_toggler', true);
                    xhr.setRequestHeader('Content-Type', 'application/json');
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                console.log('Discovery mode state updated successfully.');
                            } else {
                                console.error('Error updating discovery mode state.');
                            }
                        }
                    };
                    xhr.send(JSON.stringify({ discovery_mode: discovery_mode }));
                    console.log("Sent request")
                });
            }



            setTimeout(function() {
                var flashMessage = document.querySelector('.flash-message');
                if (flashMessage) {
                    flashMessage.style.display = "none";
                }
            }, 7000);
        });
    </script>

<script>
    function openTab(tabName) {
        // Get all elements with class="tab-content" and hide them
        var tabContents = document.getElementsByClassName("tab-content");
        for (var i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove("active");
        }

        // Get all elements with class="tab" and remove the class "active"
        var tabs = document.getElementsByClassName("tab");
        for (var i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove("active");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).classList.add("active");
        event.currentTarget.classList.add("active");
    }

</script>


    {% endblock %}


