{% if iframe %}
{% extends 'layout_iframe.html' %}
{% else %}
{% extends 'layout_order_chat.html' %}
{% endif %}

<head>
    <meta name="description" content="Discover the best AI-powered restaurants in Keflavik, Iceland with MOM AI's search tool. Find locations, menus, and order food easily.">
    <link rel="canonical" href="https://mom-ai-restaurant.pro/ai-restaurants?location=KeflavÃ­k,Iceland" />
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Restaurant",
      "name": "MOM AI Restaurant Search",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Hafnargata 18",
        "addressLocality": "Keflavik",
        "addressRegion": "ReykjanesbÃ¦r",
        "postalCode": "230",
        "addressCountry": "IS"
      },
      "telephone": "+3541234567",
      "url": "https://mom-ai-restaurant.pro/ai-restaurants?location=KeflavÃ­k,Iceland"
    }
    </script>
</head>

{% block content %}

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="flash-messages">
            <div class="flash-message">{{ messages[-1] }}</div>
        </div>
    {% endif %}
{% endwith %}

<style>
    .button:disabled {
        border: 3px solid gray;
        background-color: gray;
        cursor: not-allowed;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/web3@1.3.5/dist/web3.min.js"></script>

<div style="width: 100%; max-width: 400px; margin: auto; height: 80vh; display: flex; flex-direction: column; justify-content: space-between;">
    
    <div id="overlay" style="position: fixed; width: 100%; height: 100%; top: 0; left: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000;">
        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 300px; width: 90%;">
            <h2>Select Language & Start</h2>
            <select id="languageSelectOverlay" style="margin: 10px 0; padding: 10px; width: 100%;">
                <option value="en-US">English (US) ğŸ‡ºğŸ‡¸</option>
                <option value="es-ES">Spanish ğŸ‡ªğŸ‡¸</option>
                <option value="zh-CN">Chinese (Simplified) ğŸ‡¨ğŸ‡³</option>
                <option value="hi-IN">Hindi ğŸ‡®ğŸ‡³</option>
                <option value="ar-SA">Arabic ğŸ‡¸ğŸ‡¦</option>
                <option value="fr-FR">French ğŸ‡«ğŸ‡·</option>
                <option value="ru-RU">Russian ğŸ‡·ğŸ‡º</option>
                <option value="ja-JP">Japanese ğŸ‡¯ğŸ‡µ</option>
                <option value="de-DE">German ğŸ‡©ğŸ‡ª</option>
                <option value="pt-BR">Portuguese ğŸ‡§ğŸ‡·</option>
            </select>
            <button onclick="startChat()" style="padding: 10px; width: 100%;">Start</button>
            <!--
            <p style="font-size: 14px; margin-top: 5px;">Connect your web3 wallet<br>&<br>get MOM tokens upon placing the order.</p>
            <button id="connectWalletButtonOverlay" onclick="connectWallet()" style="margin-top: 10px; padding: 10px; width: 100%;">Connect Web3 Wallet</button>
            <p id="walletSuccessMessage" style="display: none; color: green; margin-top: 10px;">Wallet connected successfully!<br>Order and get MOM</p>
            -->
        </div>
    </div>
    
    <!--
    <script>
        async function connectWallet() {
            let accounts;
    
            if (window.ethereum) {
                try {
                    // Request account access if needed
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    
                    const account = accounts[0];
    
                    // Store account in local storage
                    localStorage.setItem("web3_wallet", account);
    
                    // Hide the connect wallet button
                    document.getElementById('connectWalletButtonOverlay').style.display = 'none';
    
                    // Show the success message
                    document.getElementById('walletSuccessMessage').style.display = 'block';
                
                    // Fetch and display MOM token balance
                    await fetchTokenBalance(account);
                } catch (error) {
                    console.error('User rejected the request:', error);
                    return;
                }
            }
        }

        connectWallet()
        
        async function fetchTokenBalance(account) {
            const tokenAddress = '0xdB1022f9fABB6B6208969ac289fFd69957eE3092'; // Replace with your MOM token contract address
            const tokenABI = [
                // Only the 'balanceOf' function is needed here
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "_owner",
                            "type": "address"
                        }
                    ],
                    "name": "balanceOf",
                    "outputs": [
                        {
                            "name": "balance",
                            "type": "uint256"
                        }
                    ],
                    "type": "function"
                }
            ];

            const web3 = new Web3(window.ethereum);
            const tokenContract = new web3.eth.Contract(tokenABI, tokenAddress);

            try {
                const balance = await tokenContract.methods.balanceOf(account).call();
                const formattedBalance = web3.utils.fromWei(balance, 'ether'); // Adjust if the token has different decimals
                localStorage.setItem("momsBalance", formattedBalance)
                document.getElementById('tokenBalance').innerText = 'MOM Token Balance: ' + formattedBalance;
            } catch (error) {
                console.error('Error fetching token balance', error);
                document.getElementById('tokenBalance').innerText = 'Error fetching token balance';
            }
        }
    </script>

    <div id="tokenBalance" style="text-align: center; margin: 10px 0; font-size: 16px; color: black;">
        Connect wallet to see MOM token balance
    </div>
    -->

    <header style="background-color: #000000; color: white; padding: 10px; text-align: center;" id="orderHeader">
        Conversate with {{ restaurant_name.replace("_"," ") }} AI-Assistant
    </header>
    <div id="chatBox" style="overflow-y: auto; flex-grow: 1; background: white; padding: 10px;">
        <div id="greetingMessage" style="text-align: center; margin: 20px; font-size: 15px;">
            {% if restaurant.res_logo %}
            <div class="restaurant-logo" style="text-align: center; margin-bottom: 10px;" id="restaurantLogo">
                <img src="{{ url_for('serve_image', file_id=restaurant.res_logo or '666af654dee400a1d635eb08') }}" alt="Restaurant Logo" style="height: auto; width: auto; max-width: 200px; max-height: 200px;">
            </div>
            {% else %}
            <div class="restaurant-logo" style="text-align: center; margin-bottom: 10px;" id="restaurantLogo">
                <img src="/static/images/Black Bold Initial AI Business Logo.png" alt="Restaurant Logo" style="height: auto; width: auto; max-width: 200px; max-height: 200px;">
            </div>  
            {% endif %}
            {% if restaurant_website_url != "No URL provided" %}
                <p id="welcomeMessage" style="margin-bottom: 7px;">Welcome at <a href='{{ restaurant_website_url }}' target="_blank"><b><u>{{ restaurant_name.replace("_"," ") }}</u></b></a>.<br>Feel free to check out the menu <a href='{{ url_for("show_restaurant_profile_public", unique_azz_id=unique_azz_id) }}' target="_blank"><b><u>here.</u></b></a><!-- <br>Click below to start ordering. --></p>
            {% else %}
                <p id="welcomeMessage">Welcome at <b><u>{{ restaurant_name.replace("_"," ") }}</u></b>. <br>I will guide you through the whole ordering journey.<!-- <br>Click below to start chatting. </p> -->
            {% endif %}
            
            {% if default_menu %}
                <p id="offMessage">{{ restaurant_name }} hasn't uploaded the menu yet. Come back laterğŸ˜‰</p>
            {% else %}
                {% if assistant_turned_on and isWorkingHours %}
                {% else %}
                <p id="offMessage"><b>We are currently off. You will be able to make the order later.</b></p>
                {% endif %}
            {% endif %}
        </div>
    </div>

<footer id="chatInputFooter" style="background-color: #000000; color: white; padding: 10px; position: relative; display: flex; flex-direction: column; align-items: center;">
    <input type="text" id="userMessage" placeholder="Type your message here..." style="width: 70%; padding: 10px; border: none; font-size: 16px;" disabled>
    <div style="display: flex; flex-direction: row; gap: 10px; margin-top: 7px;">
        <button id="sendButton" onclick="sendMessage()" style="background: none; border: 3px solid white; color: white; font-size: 16px; align-items: center;" class="button" disabled>Send</button>
        <button id="micButton" style="background: none; border: 3px solid white; color: white; font-size: 16px; align-items: center;">ğŸ¤</button>
    </div>
    <div id="spinner" style="display: none; position: absolute; top: 10px; right: 10px;">
        <img src="/static/assets/loading-gif.gif" alt="Loading..." style="width: 40px; height: 40px;">
    </div>
    <!-- <p style="margin-top: 5px; font-size: 17px">Please, opt the language you speak</p>
    <select id="languageSelect" style="margin-top: 10px; padding: 5px;" value="en-US">
        <option value="en-US">English (US)ğŸ‡ºğŸ‡¸</option>
        <option value="es-ES">SpanishğŸ‡ªğŸ‡¸</option>
        <option value="uk-UA">UkrainianğŸ‡ºğŸ‡¦</option>
        <option value="pl-PL">PolishğŸ‡µğŸ‡±</option>
    </select> -->
</footer>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    window.onload = function() {
    
    
    let currentThreadId = null;
    let currentAssistantId = null;
    let isRecording = false;
    let blockMicButton = false;
    let mediaRecorder;
    let audioChunks = [];
    let userLanguage = 'en-US';

    // Dictionary for translations (can be expanded)
    const restaurant_name = "{{ restaurant_name }}";
    
    const translations = {
    'en-US': {
        initialMessage: "Hello, welcome in",
        phrase: "How can I help you?",
        makeOrder: `Conversate with ${restaurant_name} AI-Assistant`,
        typeMessage: "Type your message hereâœï¸",
        send: "Send",
        offMessage: "We are currently off. You will be able to make the order later."
    },
    'es-ES': {
        initialMessage: "Hola, bienvenido a",
        phrase: "Â¿CÃ³mo puedo ayudarte?",
        makeOrder: `Converse con el asistente AI de ${restaurant_name}`,
        typeMessage: "Escriba su mensaje aquÃ­âœï¸",
        send: "Enviar",
        offMessage: "Actualmente estamos cerrados. PodrÃ¡ hacer el pedido mÃ¡s tarde."
    },
    'zh-CN': {
        initialMessage: "æ‚¨å¥½ï¼Œæ¬¢è¿æ¥åˆ°",
        phrase: "æˆ‘èƒ½å¸®æ‚¨ä»€ä¹ˆï¼Ÿ",
        makeOrder: `ä¸ ${restaurant_name} AI åŠ©æ‰‹å¯¹è¯`,
        typeMessage: "åœ¨è¿™é‡Œè¾“å…¥æ‚¨çš„æ¶ˆæ¯âœï¸",
        send: "å‘é€",
        offMessage: "æˆ‘ä»¬ç°åœ¨ä¸è¥ä¸šã€‚ç¨åæ‚¨å¯ä»¥ä¸‹è®¢å•ã€‚"
    },
    'hi-IN': {
        initialMessage: "à¤¨à¤®à¤¸à¥à¤¤à¥‡, à¤®à¥‡à¤‚ à¤†à¤ªà¤•à¤¾ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ",
        phrase: "à¤®à¥ˆà¤‚ à¤†à¤ªà¤•à¥€ à¤•à¥ˆà¤¸à¥‡ à¤¸à¤¹à¤¾à¤¯à¤¤à¤¾ à¤•à¤° à¤¸à¤•à¤¤à¤¾ à¤¹à¥‚à¤?",
        makeOrder: `${restaurant_name} AI-à¤¸à¤¹à¤¾à¤¯à¤• à¤•à¥‡ à¤¸à¤¾à¤¥ à¤¬à¤¾à¤¤à¤šà¥€à¤¤ à¤•à¤°à¥‡à¤‚`,
        typeMessage: "à¤¯à¤¹à¤¾à¤‚ à¤…à¤ªà¤¨à¤¾ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤Ÿà¤¾à¤‡à¤ª à¤•à¤°à¥‡à¤‚âœï¸",
        send: "à¤­à¥‡à¤œà¥‡à¤‚",
        offMessage: "à¤¹à¤® à¤«à¤¿à¤²à¤¹à¤¾à¤² à¤¬à¤‚à¤¦ à¤¹à¥ˆà¤‚à¥¤ à¤†à¤ª à¤¬à¤¾à¤¦ à¤®à¥‡à¤‚ à¤‘à¤°à¥à¤¡à¤° à¤•à¤° à¤ªà¤¾à¤à¤‚à¤—à¥‡à¥¤"
    },
    'ar-SA': {
        initialMessage: "Ù…Ø±Ø­Ø¨Ø§ØŒ Ù…Ø±Ø­Ø¨Ø§ Ø¨ÙƒÙ… ÙÙŠ",
        phrase: "ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ",
        makeOrder: `ØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù€${restaurant_name}`,
        typeMessage: "Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§âœï¸",
        send: "Ø¥Ø±Ø³Ø§Ù„",
        offMessage: "Ù†Ø­Ù† Ø­Ø§Ù„ÙŠØ§ Ù…ØºÙ„Ù‚ÙˆÙ†. Ø³ØªØªÙ…ÙƒÙ† Ù…Ù† ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§."
    },
    'fr-FR': {
        initialMessage: "Bonjour, bienvenue Ã ",
        phrase: "Comment puis-je vous aider?",
        makeOrder: `Discutez avec l'assistant AI de ${restaurant_name}`,
        typeMessage: "Tapez votre message iciâœï¸",
        send: "Envoyer",
        offMessage: "Nous sommes actuellement fermÃ©s. Vous pourrez passer la commande plus tard."
    },
    'ru-RU': {
        initialMessage: "Ğ—Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹Ñ‚Ğµ, Ğ´Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²",
        phrase: "Ğ§ĞµĞ¼ Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ?",
        makeOrder: `ĞĞ±Ñ‰Ğ°Ğ¹Ñ‚ĞµÑÑŒ Ñ AI-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ¾Ğ¼ ${restaurant_name}`,
        typeMessage: "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ·Ğ´ĞµÑÑŒâœï¸",
        send: "ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ",
        offMessage: "ĞœÑ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ñ‹. Ğ’Ñ‹ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· Ğ¿Ğ¾Ğ·Ğ¶Ğµ."
    },
    'ja-JP': {
        initialMessage: "ã“ã‚“ã«ã¡ã¯ã€ã‚ˆã†ã“ã",
        phrase: "ã©ã®ã‚ˆã†ã«ãŠæ‰‹ä¼ã„ã§ãã¾ã™ã‹ï¼Ÿ",
        makeOrder: `${restaurant_name} AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨å¯¾è©±ã™ã‚‹`,
        typeMessage: "ã“ã“ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›âœï¸",
        send: "é€ä¿¡",
        offMessage: "ç¾åœ¨å–¶æ¥­æ™‚é–“å¤–ã§ã™ã€‚å¾Œã§æ³¨æ–‡ã§ãã¾ã™ã€‚"
    },
    'de-DE': {
        initialMessage: "Hallo, willkommen in",
        phrase: "Wie kann ich Ihnen helfen?",
        makeOrder: `Unterhalten Sie sich mit dem KI-Assistenten von ${restaurant_name}`,
        typeMessage: "Geben Sie hier Ihre Nachricht einâœï¸",
        send: "Senden",
        offMessage: "Wir haben derzeit geschlossen. Sie kÃ¶nnen die Bestellung spÃ¤ter aufgeben."
    },
    'pt-BR': {
        initialMessage: "OlÃ¡, bem-vindo ao",
        phrase: "Como posso ajudar?",
        makeOrder: `Converse com o Assistente de IA de ${restaurant_name}`,
        typeMessage: "Digite sua mensagem aquiâœï¸",
        send: "Enviar",
        offMessage: "Estamos atualmente fechados. VocÃª poderÃ¡ fazer o pedido mais tarde."
    }
};




    function startChat() {
        userLanguage = document.getElementById('languageSelectOverlay').value;

        sessionStorage.setItem('userLanguage', userLanguage);
        console.log("Setup language (", userLanguage, ") in session")

        // Hide the overlay
        document.getElementById('overlay').style.display = 'none';

        // Translate the texts
        translateTexts(userLanguage);

        // Start the conversation
        startConversation();
        /*
        // Fetch MOM token balance if wallet is connected
        const account = localStorage.getItem("web3_wallet");
        if (account) {
            fetchTokenBalance(account);
        } else {
            document.getElementById('tokenBalance').innerText = 'Connect wallet to see MOM token balance';
        }
        */    
    }

    window.startChat = startChat;

    function translateTexts(language) {
        const translation = translations[language];
        document.getElementById('orderHeader').textContent = `${translation.makeOrder}`;
        document.getElementById('userMessage').placeholder = translation.typeMessage;
        document.getElementById('sendButton').textContent = translation.send;
        if (document.getElementById('offMessage')){
        document.getElementById('offMessage').textContent = translation.offMessage;
        }
    }

    function startConversation() {
        const assistantId = "{{ assistant_id }}";
        fetch(`/assistant_start/${assistantId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ assistant_id: '{{ assistant_id }}' })
        })
        .then(response => response.json())
        .then(data => {
            currentThreadId = data.thread_id;
            currentAssistantId = data.assistant_id;

            console.log("Received Thread ID: ", data.thread_id);
            console.log("Current Assistant ID: ", data.assistant_id);
            
            document.getElementById('restaurantLogo').style.display = 'none';
            document.getElementById('welcomeMessage').style.display = 'none';

            const translation = translations[userLanguage];
            const initialMessage = `${translation.initialMessage} {{ restaurant_name.replace('_', ' ') }}.<br>${translation.phrase}`;
            
            {% if assistant_turned_on and isWorkingHours %}
            appendMessage(initialMessage, 'assistant');
            {% endif %}

            
            enableInput();
        })
        .catch(error => {
            console.error("Error starting conversation: ", error);
        });
    }

    function enableInput() {
        console.log("Enabling input fields and buttons");
        document.getElementById('userMessage').disabled = false;
        document.querySelector('button[onclick="sendMessage()"]').disabled = false;
        document.getElementById('micButton').disabled = false;
        console.log("Input and buttons enabled");
    }

    
    window.sendMessage = function sendMessage() {
    const userMessage = document.getElementById('userMessage').value;
    console.log("Send button clicked");
    console.log("User message: ", userMessage);
    if (userMessage.trim() === '') {
        console.log("Empty message, not sending.");
        return;
    }

    appendMessage(userMessage, 'user');

    const spinner = document.getElementById('spinner');
    const userMessageInput = document.getElementById('userMessage');
    const sendButton = document.querySelector('button[onclick="sendMessage()"]');

    if (spinner) {
        spinner.style.display = 'block';
        showWittyPhrase(true);
    }
    userMessageInput.disabled = true;
    sendButton.disabled = true;

    const unique_azz_id = "{{ unique_azz_id }}";
    let llmResponse;

    const formData = new FormData();
    let userLanguage = sessionStorage.getItem('userLanguage');
    
    formData.append('message', userMessage);
    formData.append('language', userLanguage);
    formData.append('thread_id', currentThreadId);
    formData.append('assistant_id', currentAssistantId);

    fetch(`/generate_response/${unique_azz_id}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log("Received response: ", data);
        llmResponse = data.response_llm;
        // appendMessage(llmResponse, 'assistant');

        if (llmResponse.includes("/payment_buffer") || llmResponse.includes("Thank you very much! You ordered")) {
            appendMessage(llmResponse, "assistant")
            return; // Terminate the function here
        }

        const voiceFormData = new FormData();
        voiceFormData.append('full_gpts_response', llmResponse);
        voiceFormData.append('language', userLanguage);

        return fetch(`/generate_voice_output/${unique_azz_id}`, {
            method: 'POST',
            body: voiceFormData
        });
    })
    .then(response => response.blob())
    .then(audioBlob => {
        console.log("Received audio blob");
        const audioUrl = window.URL.createObjectURL(audioBlob);
        appendMessage(llmResponse, 'assistant');
        const audio = new Audio(audioUrl);
        console.log("Started Playing audio");
        audio.play();

        if (spinner) spinner.style.display = 'none';
        showWittyPhrase(false);
        userMessageInput.value = '';
        userMessageInput.disabled = false;
        sendButton.disabled = false;
    })
    .catch(error => {
        console.error("Error: ", error);
        if (spinner) spinner.style.display = 'none';
        showWittyPhrase(false);
        userMessageInput.disabled = false;
        sendButton.disabled = false;
    });
}



    window.showWittyPhrase = function showWittyPhrase(visible, voice_input) {
        const phrases = [
            "Your Order is Our Command! âœ¨",
            "The Beauty in Simplicity ğŸ˜®â€ğŸ’¨",
            "Love is AI Serving You ğŸ’“",
            "Prepare for the Tasty Journey ğŸ˜‹",
            "Don't Worry, Just Eat It! ğŸ½ï¸"
        ];
        const phraseDisplay = document.getElementById('wittyPhrase');
        if (visible) {
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            if (phraseDisplay) {
                phraseDisplay.textContent = randomPhrase;
                phraseDisplay.style.display = 'block';
            }
        } else if (visible && voice_input) {  
            phraseDisplay.textContent = "Please, speak your truth NOW!";
            phraseDisplay.style.display = 'block'; 
        } else {
            if (phraseDisplay) {
                phraseDisplay.style.display = 'none';
            }
        }
    }

    const footer = document.getElementById('chatInputFooter');
    const wittyPhraseDiv = document.createElement('div');
    wittyPhraseDiv.id = 'wittyPhrase';
    wittyPhraseDiv.style.marginBottom = '20px';
    wittyPhraseDiv.style.marginRight = '7px';
    wittyPhraseDiv.style.fontSize = '16px';
    wittyPhraseDiv.style.display = 'none';
    footer.insertBefore(wittyPhraseDiv, footer.firstChild);

    function appendMessage(message, sender) {
    // Insert line breaks between sentences
    message = message.replace(/([.!?])\s*(?=[A-Z])/g, "$1<br>");

    if (message.includes("/payment_buffer")) {
        const isIframeRaw = "{{ iframe }}";
        let isIframe = isIframeRaw === "True";

        if (isIframe) {
            let clickable_link = `<a href="${message}" style="color: #00ffff;" target="_blank"><u>Press here to proceedğŸ‘†</u></a>`;
            message = `Order formed successfully. Please, follow this link to finish the purchase: ${clickable_link}`;
        } else {
            window.location.href = message;
            return;
        }
    } else if (message.includes("Come to the restaurant and pick up")) {
        const isIframeRaw = "{{ iframe }}";
        let isIframe = isIframeRaw === "True";

        if (isIframe) {
            message = message;
            document.getElementById('userMessage').disabled = true;
            document.querySelector('button[onclick="sendMessage()"]').disabled = true;
            document.getElementById('micButton').disabled = true;
        } else {
            const unique_azz_id = "{{ unique_azz_id }}";
            window.location.href = `/no-payment-order-placed/${unique_azz_id}`;
            return;
        }
    }

    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        margin-top: 10px; 
        margin-right: 10px; 
        margin-left: 10px;     
        margin-bottom: 40px; 
        padding: 15px; 
        border-radius: 15px;
        font-family: 'Arial', sans-serif;
        font-size: 16px;
        line-height: 1.6;
        word-wrap: break-word;
        max-width: 80%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    `;
    
    try {
        const htmlContent = marked.parse(message);
        messageDiv.innerHTML = htmlContent;
    } catch (error) {
        console.error("Marked conversion error: ", error);
        messageDiv.textContent = message;
    }

    const iconDiv = document.createElement('div');
    iconDiv.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; overflow: hidden; margin: 10px;';

    const messageContainer = document.createElement('div');

    if (sender === 'user') {
        messageDiv.style.backgroundColor = '#f1f1f1';
        messageDiv.style.color = '#333';
        messageDiv.style.textAlign = 'left';

        const userIcon = document.createElement('img');
        userIcon.src = '/static/images/user_icon.png';
        userIcon.style.width = '100%';
        userIcon.style.height = '100%';
        userIcon.style.objectFit = 'cover';
        iconDiv.appendChild(userIcon);

        messageContainer.style.cssText = 'display: flex; flex-direction: row; align-items: flex-start;';
        messageContainer.appendChild(iconDiv);
        messageContainer.appendChild(messageDiv);

    } else if (sender === 'assistant') {
        messageDiv.style.backgroundColor = '#333';
        messageDiv.style.color = '#ffffff';
        messageDiv.style.textAlign = 'right';

        const assistantIcon = document.createElement('img');
        assistantIcon.src = '{{ url_for("serve_image", file_id=restaurant.res_logo or "666af654dee400a1d635eb08") }}';
        assistantIcon.style.width = '100%';
        assistantIcon.style.height = '100%';
        assistantIcon.style.objectFit = 'contain';
        iconDiv.appendChild(assistantIcon);

        messageContainer.style.cssText = 'display: flex; flex-direction: row-reverse; align-items: flex-start;';
        messageContainer.appendChild(iconDiv);
        messageContainer.appendChild(messageDiv);

    } else if (sender === 'system') {
        messageDiv.style.backgroundColor = '#4CAF50';
        messageDiv.style.color = 'white';
        messageDiv.style.textAlign = 'center';

        messageContainer.style.cssText = 'display: flex; flex-direction: column; align-items: center;';
        messageContainer.appendChild(messageDiv);
    }

    document.getElementById('chatBox').appendChild(messageContainer);
    scrollToBottom(messageContainer);
}


    window.appendMessage = appendMessage;

    function scrollToBottom(element) {
        const chatBox = document.getElementById('chatBox');
        chatBox.scrollTop = element.offsetTop + element.offsetHeight;
    }

    window.scrollToBottom = scrollToBottom;

    var flashMessages = document.querySelector('.flash-messages');
    if (flashMessages) {
        setTimeout(function() {
            flashMessages.style.display = 'none';
        }, 5000);
    }


    /*
    async function speak(text) {
        const synthesis = window.speechSynthesis;
        const utterance = new SpeechSynthesisUtterance(text);
        
        let userLanguage = sessionStorage.getItem('userLanguage');
        console.log("The language user selected on start (accessed from speak function): ", userLanguage)
        
        // utterance.lang = document.getElementById('languageSelect').value;
        utterance.lang = userLanguage;
        synthesis.speak(utterance);
    }

    window.speak = speak;
    */
    
    const micButton = document.getElementById('micButton');
    micButton.addEventListener('click', () => {
        if (isRecording && !blockMicButton) {
            mediaRecorder.stop();
            micButton.textContent = 'ğŸ¤';
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'none';
        } else if (!isRecording && blockMicButton) {
            mediaRecorder.stop();
            micButton.textContent = 'ğŸ¤';
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'none';
        } else {
            startRecording();
            micButton.textContent = 'â¹ï¸';
            const spinner = document.getElementById('spinner');
            spinner.style.display = 'block';
        }
        isRecording = !isRecording;
    });

    async function startRecording() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

    mediaRecorder.ondataavailable = event => {
        audioChunks.push(event.data);
    };

    mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append('file', audioBlob, 'audio.webm');
        const userLanguage = sessionStorage.getItem('userLanguage');
        formData.append('language', userLanguage);

        const spinner = document.getElementById('spinner');
        const userMessageInput = document.getElementById('userMessage');
        const sendButton = document.querySelector('button[onclick="sendMessage()"]');
        const micButton = document.getElementById('micButton');

        try {
            blockMicButton = true;
            if (spinner) {
                spinner.style.display = 'block';
                showWittyPhrase(true);
            }
            if (userMessageInput) userMessageInput.disabled = true;
            if (sendButton) sendButton.disabled = true;
            if (micButton) micButton.disabled = true;

            const transcribeResponse = await fetch('/transcribe_voice', {
                method: 'POST',
                body: formData
            });

            const transcribeData = await transcribeResponse.json();
            if (transcribeResponse.ok && transcribeData.status === 'success') {
                const transcription = transcribeData.transcription;
                appendMessage(transcription, "user");

                const responseFormData = new FormData();
                responseFormData.append('message', transcription);
                responseFormData.append('thread_id', currentThreadId);
                responseFormData.append('assistant_id', currentAssistantId);
                responseFormData.append('language', userLanguage);

                const unique_azz_id = "{{ unique_azz_id }}";
                let llmResponse;

                const response = await fetch(`/generate_response/${unique_azz_id}`, {
                    method: 'POST',
                    body: responseFormData
                });

                const data = await response.json();
                llmResponse = data.response_llm;

                if (llmResponse.includes("/payment_buffer") || llmResponse.includes("Thank you very much! You ordered")) {
                    appendMessage(llmResponse, "assistant")
                    return; // Terminate the function here
                }

                const voiceFormData = new FormData();
                voiceFormData.append('full_gpts_response', llmResponse);
                voiceFormData.append('language', userLanguage);

                const voiceResponse = await fetch(`/generate_voice_output/${unique_azz_id}`, {
                    method: 'POST',
                    body: voiceFormData
                });

                const audioBlob = await voiceResponse.blob();
                console.log("Received audio blob");
                const audioUrl = window.URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                appendMessage(llmResponse, 'assistant');
                
                console.log("Started Playing audio");
                audio.play();

                blockMicButton = false;
            } else {
                appendMessage('Transcription failed. Please try again.', 'system');
                blockMicButton = false;
            }
        } catch (error) {
            appendMessage('An error occurred. Please try again.', 'system');
            blockMicButton = false;
        } finally {
            if (spinner) {
                spinner.style.display = 'none';
                showWittyPhrase(false);
            }
            if (userMessageInput) userMessageInput.disabled = false;
            if (sendButton) sendButton.disabled = false;
            if (micButton) micButton.disabled = false;
            audioChunks = [];
        }

        stream.getTracks().forEach(track => track.stop());
    };

    mediaRecorder.start();
}
};
</script>


{% endblock %}